<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Music ConnectZ v6 bi K-Oth</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <script src="https://js.stripe.com/v3/"></script>
  <script src="stripe-config.js"></script>
  <style>
    :root {
      --primary: #2196F3;
      --primary-dark: #1565C0;
      --accent: #FF9800;
      --bg: #f5f5f5;
      --surface: #ffffff;
      --text: #333333;
      --text-light: #666666;
      --border: #e0e0e0;
      --success: #4CAF50;
      --danger: #F44336;
    }
    [data-theme="dark"] {
      --bg: #1a1a1a;
      --surface: #2d2d2d;
      --text: #e0e0e0;
      --text-light: #b0b0b0;
      --border: #404040;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); }
    .container { display: flex; flex-direction: column; min-height: 100vh; }
    .header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 12px 14px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; flex-wrap: nowrap; gap: 8px; width: 100%; }
    .nav-wrapper { display: flex; gap: 8px; flex: 0 0 auto; }
    .theme-toggle { background: rgba(255,255,255,0.3); border: none; color: white; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; }
    .theme-toggle:hover { background: rgba(255,255,255,0.5); }
    .header-center { text-align: center; flex: 1 1 auto; min-width: 150px; }
    .header-title { font-size: 16px; font-weight: 700; }
    .header-subtitle { font-size: 9px; opacity: 0.9; margin-top: 2px; }
    .nav-btn { background: rgba(255,255,255,0.3); border: none; color: white; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; }
    .nav-btn:hover { background: rgba(255,255,255,0.5); }
    .header-right { display: flex; gap: 8px; align-items: center; flex: 0 0 auto; }
    .balance { background: rgba(255,255,255,0.25); padding: 6px 10px; border-radius: 6px; text-align: center; font-size: 11px; cursor: pointer; }
    .profile-pic { width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 18px; background: rgba(255,255,255,0.2); cursor: pointer; }
    .profile-pic img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-wrapper { position: relative; display: inline-block; }
    .rating-badge { position: absolute; right: -6px; bottom: -6px; background: #FFD700; color: #111; padding: 4px 8px; border-radius: 10px; font-weight: 800; font-size: 11px; box-shadow: 0 2px 6px rgba(0,0,0,0.25); }
    .tabs { display: flex; background: var(--surface); border-bottom: 2px solid var(--border); overflow-x: auto; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
    .tab-btn { flex: 1; padding: 11px 12px; border: none; background: transparent; cursor: pointer; font-size: 11px; font-weight: 600; color: var(--text-light); border-bottom: 3px solid transparent; white-space: nowrap; min-width: 65px; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .content { flex: 1; overflow-y: auto; padding: 16px; max-width: 1000px; margin: 0 auto; width: 100%; }
    .tab { display: none; }
    .tab.active { display: block; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    .card-header { font-size: 14px; font-weight: 700; margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 12px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 9px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 12px; font-family: inherit; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 8px rgba(33, 150, 243, 0.2); }
    .btn { padding: 9px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; background: var(--primary); color: white; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; }
    .btn:hover { background: var(--primary-dark); }
    .btn-success { background: var(--success); }
    .btn-success:hover { background: #45a049; }
    .btn-danger { background: var(--danger); }
    .btn-danger:hover { background: #da190b; }
    .btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border); }
    .btn-small { padding: 5px 10px; font-size: 10px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .modal { display: none !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 5000; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
    .modal.active { display: flex !important; }
    .modal-content { background: var(--surface); border-radius: 12px; padding: 20px; max-width: 550px; width: 100%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
    .modal-header h2 { font-size: 14px; color: var(--primary); }
    .close-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-light); }
    .close-btn:hover { color: var(--danger); }
    .tag { display: inline-block; background: var(--bg); padding: 4px 8px; border-radius: 6px; font-size: 10px; margin: 2px; }
    .persona-card { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border-radius: 10px; padding: 16px; margin-bottom: 12px; }
    .persona-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
    .persona-name { font-size: 16px; font-weight: 700; }
    .persona-btn { background: var(--bg); padding: 10px; border-radius: 8px; cursor: pointer; border: 2px solid var(--border); text-align: center; font-weight: 700; font-size: 12px; color: var(--text); }
    .persona-btn:hover { border-color: var(--primary); }
    .post-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 14px; }
    .post-header { display: flex; gap: 8px; margin-bottom: 10px; }
    .post-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; overflow: hidden; flex-shrink: 0; }
    .post-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .post-info { flex: 1; }
    .post-user { font-weight: 700; font-size: 12px; }
    .post-meta { font-size: 10px; color: var(--text-light); }
    .post-content { font-size: 12px; margin-bottom: 10px; line-height: 1.4; }
    .post-actions { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
    .skill-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .skill-btn { padding: 8px 10px; border: 1px solid var(--border); background: var(--bg); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px; text-align: center; position: relative; }
    .skill-btn:hover { border-color: var(--primary); }
    .skill-btn.sel { background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%) !important; color: white !important; border: 3px solid #1565C0 !important; box-shadow: 0 0 12px rgba(33, 150, 243, 0.6) !important; transform: scale(1.08) !important; font-weight: 700 !important; }
    .skill-btn.any-skill { background: var(--accent); color: white; border-color: var(--accent); }
    .skill-btn.any-skill::after { content: '🔄'; position: absolute; top: 2px; right: 4px; font-size: 9px; }
    .skill-btn.any-skill.sel { background: linear-gradient(135deg, #FF9800 0%, #E65100 100%) !important; border: 3px solid #E65100 !important; box-shadow: 0 0 12px rgba(255, 152, 0, 0.6) !important; transform: scale(1.08) !important; }
    .skill-item { background: var(--bg); padding: 10px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: var(--text); }
    .skill-item-name { font-weight: 600; flex: 1; color: var(--text); }
    .skill-item-exp { color: var(--text-light); font-size: 10px; margin-right: 8px; }
    .skill-item-actions { display: flex; gap: 4px; }
    .toggle-btn { display: inline-block; padding: 6px 12px; border-radius: 6px; border: 2px solid var(--border); background: var(--bg); cursor: pointer; font-weight: 600; font-size: 11px; margin: 4px; }
    .toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .filter-panel { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    .filter-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
    .filter-badge { background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-left: 6px; }
    .gps-status { font-size: 11px; color: var(--text-light); margin-top: 6px; padding: 8px; background: var(--bg); border-radius: 6px; display: none; }
    .gps-status.active { display: block; }
    .genre-btn { padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; margin: 4px; display: inline-block; font-size: 12px; font-weight: 600; }
    .genre-btn:hover { border-color: var(--primary); }
    .genre-btn.sel { background: var(--primary); color: white; border-color: var(--primary); }
    #collabMap { width: 100%; height: 500px; border-radius: 10px; margin-bottom: 16px; }
    .map-container { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 0; margin-bottom: 16px; overflow: hidden; }
    .user-card-on-map { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .user-card-header { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .user-card-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 16px; overflow: hidden; flex-shrink: 0; }
    .user-card-title { flex: 1; }
    .user-name { font-weight: 700; font-size: 12px; }
    .user-rating { font-size: 11px; color: #FFD700; }
    .user-card-content { font-size: 10px; line-height: 1.5; }
    .user-card-content div { margin-bottom: 4px; }
    .theme-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
    .theme-color-btn { border: 3px solid transparent; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 700; color: white; transition: all 0.3s; }
    .theme-color-btn:hover { transform: scale(1.05); }
    .theme-color-btn.active { border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
    .toggle-setting { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .toggle-switch { width: 50px; height: 26px; background: #ccc; border-radius: 13px; position: relative; cursor: pointer; transition: 0.3s; }
    .toggle-switch.on { background: var(--primary); }
    .toggle-switch.disabled { opacity: 0.4; cursor: not-allowed; }
    .toggle-slider { position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: 0.3s; }
    .toggle-switch.on .toggle-slider { left: 27px; }
    .verification-status { display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--bg); border-radius: 6px; margin-top: 8px; }
    .verification-status.verified { background: rgba(76, 175, 80, 0.1); color: #4CAF50; }
    .verification-status.unverified { background: rgba(244, 67, 54, 0.1); color: #F44336; }
    @media (max-width: 768px) { 
      .header { padding: 8px 10px; flex-wrap: wrap; justify-content: center; gap: 6px; } 
      .nav-wrapper { flex: 0 1 auto; order: 1; }
      .header-center { flex: 0 1 100%; order: 2; margin: 4px 0; }
      .header-title { font-size: 13px; }
      .header-subtitle { font-size: 7px; }
      .header-right { flex: 0 1 auto; order: 3; }
      .theme-toggle { padding: 5px 8px; font-size: 11px; }
      .nav-btn { padding: 5px 8px; font-size: 11px; }
      .balance { padding: 5px 8px; font-size: 9px; }
      .profile-pic { width: 28px; height: 28px; font-size: 14px; }
      .tabs { width: 100%; }
      .tab-btn { padding: 8px 6px; font-size: 9px; min-width: 50px; flex: 0 1 auto; }
      .content { padding: 10px; }
      .card { padding: 10px; margin-bottom: 10px; }
      .card-header { font-size: 12px; padding-bottom: 5px; margin-bottom: 8px; }
      .form-group { margin-bottom: 8px; }
      .form-group label { font-size: 10px; margin-bottom: 3px; }
      .form-group input, .form-group select, .form-group textarea { padding: 7px; font-size: 10px; }
      .btn { padding: 7px 10px; font-size: 10px; }
      .btn-small { padding: 4px 8px; font-size: 9px; }
      .grid-2, .grid-3 { grid-template-columns: 1fr; gap: 8px; }
      .skill-grid { grid-template-columns: 1fr; }
      .modal-content { padding: 14px; max-width: 95%; }
      .modal-header h2 { font-size: 12px; }
      .persona-name { font-size: 13px; }
      .post-header { gap: 6px; }
      .post-avatar { width: 32px; height: 32px; font-size: 14px; }
      .post-user { font-size: 10px; }
      .post-meta { font-size: 8px; }
      .post-content { font-size: 10px; }
      .filter-panel { padding: 8px; }
      .filter-row { gap: 6px; }
      .skill-btn { padding: 5px 8px; font-size: 9px; }
      .genre-btn { padding: 5px 8px; font-size: 10px; margin: 2px; }
      .toggle-btn { padding: 4px 8px; font-size: 9px; margin: 2px; }
      #collabMap { height: 250px; }
      .user-card-on-map { padding: 8px; margin-bottom: 8px; }
      .user-card-avatar { width: 28px; height: 28px; font-size: 12px; }
      .user-name { font-size: 10px; }
      .user-rating { font-size: 9px; }
      .user-card-content { font-size: 8px; }
      .theme-selector { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .theme-color-btn { padding: 8px; font-size: 11px; }
      .toggle-setting { padding: 6px 0; }
      .toggle-switch { width: 40px; height: 22px; }
      .toggle-slider { width: 16px; height: 16px; top: 3px; left: 3px; }
      .toggle-switch.on .toggle-slider { left: 21px; }
    }
    @media (max-width: 480px) {
      .header { padding: 6px 8px; }
      .nav-wrapper { gap: 4px; order: 1; }
      .header-center { order: 2; margin: 4px 0; flex: 0 1 100%; }
      .header-title { font-size: 11px; }
      .header-subtitle { font-size: 6px; }
      .header-right { order: 3; gap: 4px; }
      .theme-toggle { padding: 4px 6px; font-size: 10px; }
      .nav-btn { padding: 4px 6px; font-size: 10px; }
      .balance { padding: 4px 6px; font-size: 8px; }
      .profile-pic { width: 24px; height: 24px; font-size: 12px; }
      .tabs { width: 100%; }
      .tab-btn { padding: 6px 4px; font-size: 8px; min-width: 45px; }
      .content { padding: 8px; }
      .card { padding: 8px; margin-bottom: 8px; }
      .card-header { font-size: 11px; margin-bottom: 6px; padding-bottom: 4px; }
      .form-group { margin-bottom: 6px; }
      .form-group label { font-size: 9px; }
      .form-group input, .form-group select, .form-group textarea { padding: 6px; font-size: 9px; }
      .btn { padding: 6px 8px; font-size: 9px; }
      .btn-small { padding: 3px 6px; font-size: 8px; }
      .grid-2, .grid-3 { gap: 6px; }
      .modal-content { padding: 12px; max-width: 98%; }
      .modal-header h2 { font-size: 11px; }
      .post-avatar { width: 28px; height: 28px; font-size: 12px; }
      .post-user { font-size: 9px; }
      .post-meta { font-size: 7px; }
      .post-content { font-size: 9px; }
      #collabMap { height: 200px; }
      .user-card-avatar { width: 24px; height: 24px; font-size: 10px; }
      .user-name { font-size: 9px; }
      .user-rating { font-size: 8px; }
      .user-card-content { font-size: 7px; }
      .theme-selector { grid-template-columns: 1fr; gap: 6px; }
      .theme-color-btn { padding: 6px; font-size: 10px; }
      .toggle-switch { width: 36px; height: 20px; }
      .toggle-slider { width: 14px; height: 14px; }
      .toggle-switch.on .toggle-slider { left: 19px; }
    }
    .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 20px; }
    .auth-overlay.active { display: flex; }
    .auth-card { background: var(--surface); border-radius: 12px; padding: 20px; max-width: 380px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.35); border: 1px solid var(--border); }
    .auth-title { font-size: 16px; font-weight: 800; color: var(--primary); margin-bottom: 6px; }
    .auth-subtitle { font-size: 11px; color: var(--text-light); margin-bottom: 14px; }
    .auth-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .auth-status { margin-top: 10px; font-size: 11px; color: var(--text-light); }
    .btn-social { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border); background: white; color: #333; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; width: 100%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .btn-social:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .btn-social svg { flex-shrink: 0; }
    .btn-google { background: white; color: #3c4043; }
    .btn-google:hover { background: #f8f9fa; border-color: #dadce0; }
    .btn-apple { background: white; color: #000000; }
    .btn-apple:hover { background: #f5f5f7; border-color: #000000; }
    .btn-microsoft { background: white; color: #5E5E5E; }
    .btn-microsoft:hover { background: #f3f2f1; border-color: #8c8c8c; }
    .btn-facebook { background: white; color: #1877f2; }
    .btn-facebook:hover { background: #f0f2f5; border-color: #1877f2; }
    .btn-twitter { background: white; color: #000000; }
    .btn-twitter:hover { background: #f7f9f9; border-color: #000000; }
    .btn-linkedin { background: white; color: #0A66C2; }
    .btn-linkedin:hover { background: #f3f6f8; border-color: #0A66C2; }
    .btn-github { background: white; color: #24292e; }
    .btn-github:hover { background: #f6f8fa; border-color: #24292e; }
    [data-theme="dark"] .btn-social { background: var(--surface); color: var(--text); border-color: var(--border); }
    [data-theme="dark"] .btn-social:hover { background: var(--border); }
  </style>
</head>
<body>
<div style="position: fixed; top: 0; left: 0; right: 0; background: #FF5722; color: white; padding: 20px; text-align: center; font-weight: bold; z-index: 9999; font-size: 16px;">
  🚀 NEW VERSION - Commit: 08c1315 - Time: 2026-02-01T[CURRENT]
</div>
<div id="authOverlay" class="auth-overlay">
  <div class="auth-card">
    <div id="authMainView">
      <div class="auth-title">🔐 Login Required</div>
      <div class="auth-subtitle">Create an account or sign in to use Music ConnectZ.</div>
      
      <div class="social-login-section" style="margin-bottom: 15px;">
        <div style="text-align: center; margin-bottom: 10px; color: var(--text-light); font-size: 10px;">Continue with:</div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button class="btn-social btn-google" onclick="socialLogin('google')" title="Login with Google">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span style="flex: 1; text-align: left;">Continue with Google</span>
          </button>
          <button class="btn-social btn-apple" onclick="socialLogin('apple')" title="Login with Apple">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#000000" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01M12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
            </svg>
            <span style="flex: 1; text-align: left;">Continue with Apple</span>
          </button>
          <button class="btn-social btn-microsoft" onclick="socialLogin('microsoft')" title="Login with Microsoft">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#F25022" d="M11.4 11.4H2V2h9.4v9.4z"/>
              <path fill="#00A4EF" d="M22 11.4h-9.4V2H22v9.4z"/>
              <path fill="#7FBA00" d="M11.4 22H2v-9.4h9.4V22z"/>
              <path fill="#FFB900" d="M22 22h-9.4v-9.4H22V22z"/>
            </svg>
            <span style="flex: 1; text-align: left;">Continue with Microsoft</span>
          </button>
          <button class="btn-social btn-facebook" onclick="socialLogin('facebook')" title="Login with Facebook">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#1877F2" d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
            <span style="flex: 1; text-align: left;">Continue with Facebook</span>
          </button>
          <button class="btn-social btn-twitter" onclick="socialLogin('twitter')" title="Login with X (Twitter)">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#000000" d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            <span style="flex: 1; text-align: left;">Continue with X</span>
          </button>
          <button class="btn-social btn-linkedin" onclick="socialLogin('linkedin')" title="Login with LinkedIn">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#0A66C2" d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
            </svg>
            <span style="flex: 1; text-align: left;">Continue with LinkedIn</span>
          </button>
          <button class="btn-social btn-github" onclick="socialLogin('github')" title="Login with GitHub">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#181717" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
            <span style="flex: 1; text-align: left;">Continue with GitHub</span>
          </button>
        </div>
        <div style="text-align: center; margin: 15px 0; color: var(--text-light); font-size: 14px;">
          <span style="background: var(--background); padding: 0 10px; position: relative; z-index: 1;">or use email</span>
          <div style="height: 1px; background: var(--border); margin-top: -10px;"></div>
        </div>
      </div>
      
      <div class="form-group"><label>Username</label><input type="text" id="authOverlayUsername" placeholder="Optional display name" /></div>
      <div class="form-group"><label>Email *</label><input type="email" id="authOverlayEmail" placeholder="you@email.com" /></div>
      <div class="form-group"><label>Phone</label><input type="tel" id="authOverlayPhone" placeholder="+1234567890 (optional)" /></div>
      <div class="form-group"><label>Password *</label><input type="password" id="authOverlayPassword" placeholder="At least 8 characters" /></div>
      <div class="auth-actions">
        <button class="btn btn-success" onclick="registerUser(true)">📝 Register</button>
        <button class="btn" onclick="loginUser(true)">🔓 Login</button>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn btn-secondary" onclick="showPhoneLogin()" style="flex: 1;">📱 Phone Login</button>
        <button class="btn btn-secondary" onclick="showForgotPassword()" style="flex: 1;">🔑 Forgot Password</button>
      </div>
      <button class="btn btn-secondary" onclick="continueAsGuest()" style="width: 100%; margin-top: 10px;">👀 Continue as Guest</button>
    </div>
    
    <div id="authPhoneView" style="display: none;">
      <div class="auth-title">📱 Phone Login</div>
      <div class="auth-subtitle">Sign in with your phone number.</div>
      <div class="form-group"><label>Phone *</label><input type="tel" id="authPhoneNumber" placeholder="+1234567890" /></div>
      <div class="form-group"><label>Password *</label><input type="password" id="authPhonePassword" placeholder="Password" /></div>
      <div class="auth-actions">
        <button class="btn btn-success" onclick="loginWithPhone()">🔓 Login with Phone</button>
        <button class="btn btn-secondary" onclick="backToMainAuth()">⬅️ Back</button>
      </div>
    </div>
    
    <div id="authForgotView" style="display: none;">
      <div class="auth-title">🔑 Reset Password</div>
      <div class="auth-subtitle">We'll send you a 6-digit reset code.</div>
      <div class="form-group"><label>Email *</label><input type="email" id="authForgotEmail" placeholder="you@email.com" /></div>
      <div class="auth-actions">
        <button class="btn btn-success" onclick="requestPasswordReset()">📧 Send Reset Code</button>
        <button class="btn btn-secondary" onclick="backToMainAuth()">⬅️ Back</button>
      </div>
    </div>
    
    <div id="authResetView" style="display: none;">
      <div class="auth-title">🔐 Enter Reset Code</div>
      <div class="auth-subtitle">Check your email for the 6-digit code.</div>
      <div class="form-group"><label>6-Digit Code *</label><input type="text" id="authResetCode" placeholder="123456" maxlength="6" /></div>
      <div class="form-group"><label>New Password *</label><input type="password" id="authResetPassword" placeholder="At least 8 characters" /></div>
      <div class="auth-actions">
        <button class="btn btn-success" onclick="completePasswordReset()">✅ Reset Password</button>
        <button class="btn btn-secondary" onclick="backToMainAuth()">⬅️ Back</button>
      </div>
    </div>
    
    <div class="auth-status" id="authOverlayStatus">Not logged in</div>
  </div>
</div>
<div class="container">
  <div class="header">
    <div class="nav-wrapper"><button class="nav-btn" onclick="prevTab()">←</button><button class="nav-btn" onclick="nextTab()">→</button><button class="theme-toggle" onclick="toggleTheme()">🌙</button></div>
    <div class="header-center"><div class="header-title">🎵 Music ConnectZ v6.3 bi K-Oth</div><div class="header-subtitle">Location-Based Collaboration • 1/31/2026</div></div>
    <div class="header-right"><div class="balance" onclick="switchTab('money')">💰 $<span id="balanceAmount">0.00</span></div><div class="profile-pic" onclick="switchTab('profile')" id="headerPic">👤</div></div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('setup')">⚙️ Setup</button>
    <button class="tab-btn" onclick="switchTab('personas')">🎭 Personas</button>
    <button class="tab-btn" onclick="switchTab('examples')">🎵 Work</button>
    <button class="tab-btn" onclick="switchTab('collaborate')">🤝 Collab</button>
    <button class="tab-btn" onclick="switchTab('profile')">👤 Profile</button>
    <button class="tab-btn" onclick="switchTab('money')">💰 Money</button>
    <button class="tab-btn" onclick="switchTab('settings')">⚙️ Settings</button>
  </div>

  <div class="content">
    <div id="setup" class="tab active">
      <div class="card">
        <div class="card-header">👤 Your Profile</div>
        <div class="form-group"><label>Username *</label><input type="text" id="username" placeholder="Your name" /></div>
        <div class="grid-2"><div class="form-group"><label>📧 Email *</label><input type="email" id="email" /></div><div class="form-group"><label>📱 Phone *</label><input type="tel" id="phone" /></div></div>
        <div class="grid-2"><div class="form-group"><label>🎂 Birthday *</label><input type="date" id="birthday" /></div><div class="form-group"><label>⚧️ Gender *</label><select id="gender"><option value="">Select</option><option value="Male">🚹 Male ♂️</option><option value="Female">🚺 Female ♀️</option><option value="Non-Binary">⚧️ Non-Binary</option></select></div></div>
        <div class="form-group">
          <label>📍 Location *</label>
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <input type="text" id="location" placeholder="City, State or Zip" style="flex: 1;" />
            <button class="btn btn-secondary btn-small" onclick="requestGPS()" id="gpsBtn">📍 GPS</button>
          </div>
          <div class="gps-status" id="gpsStatus">Requesting location...</div>
        </div>
        <div class="form-group"><label>📸 Profile Picture</label><input type="file" id="profilePicFile" accept="image/*" onchange="loadProfilePic(event)" /></div>
        <div class="form-group"><label>📝 Bio</label><textarea id="bio" placeholder="About you..." style="height: 60px;"></textarea></div>
        <button class="btn btn-success" onclick="saveProfile()" style="width: 100%;">💾 Save Profile</button>
      </div>
    </div>

    <div id="personas" class="tab">
      <div class="card">
        <div class="card-header">🎭 Select Your Personas & Add Skills</div>
        <div class="grid-3">
          <button class="persona-btn" onclick="openSkillModal('indie-artist','🎤 Indie Artist')">🎤 Indie</button>
          <button class="persona-btn" onclick="openSkillModal('beat-producer','🎚️ Beat Producer')">🎚️ Producer</button>
          <button class="persona-btn" onclick="openSkillModal('mix-engineer','🎛️ Mix Engineer')">🎛️ Engineer</button>
          <button class="persona-btn" onclick="openSkillModal('designer','🎨 Designer')">🎨 Designer</button>
          <button class="persona-btn" onclick="openSkillModal('videographer','🎬 Videographer')">🎬 Video</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header">🎭 Your Personas</div>
        <div id="personasDisplay">No personas yet</div>
      </div>
    </div>

    <div id="examples" class="tab">
      <div class="card">
        <div class="card-header">🎵 Upload Work Example</div>
        <input type="hidden" id="editingExampleIdx" value="" />
        <div class="form-group"><label>🎯 Title *</label><input type="text" id="exampleTitle" placeholder="e.g., My Latest Beat" /></div>
        <div class="form-group"><label>📝 Description *</label><textarea id="exampleDesc" placeholder="Tell us about this work..." style="height: 50px;"></textarea></div>
        <div class="form-group"><label>🎵 Genre/Style *</label><button class="btn" onclick="openGenreModal()" style="width: 100%; margin-bottom: 8px;">🎵 Select Genre</button><div id="exampleGenreDisplay" style="border: 1px solid var(--border); padding: 10px; border-radius: 6px; background: var(--bg); font-size: 11px;">Click "Select Genre"</div></div>
        <div class="form-group"><label>🎧 Audio/Video File *</label><input type="file" id="exampleMedia" accept="audio/*,video/*" /><div id="currentMediaDisplay" style="margin-top: 6px; font-size: 10px; color: var(--text-light);"></div></div>
        <div class="form-group"><label>🖼️ Thumbnail Image</label><input type="file" id="exampleImage" accept="image/*" /></div>
        <div class="form-group">
          <label>🎯 Skills Used * (Required)</label>
          <div id="skillsUsedDisplay" style="border: 1px solid var(--border); padding: 10px; border-radius: 6px; background: var(--bg); font-size: 11px; max-height: 150px; overflow-y: auto; margin-bottom: 8px;" onclick="openSkillsUsedModal()">Click to select skills used</div>
          <button class="btn" onclick="openSkillsUsedModal()" style="width: 100%;">📋 Select Skills Used</button>
        </div>
        <div class="form-group"><label>🔒 Privacy</label><div style="display: flex; gap: 8px; margin-top: 8px;"><button class="toggle-btn active" onclick="setExamplePrivacy('private')">🔒 Private</button><button class="toggle-btn" onclick="setExamplePrivacy('public')">🌐 Public</button></div></div>
        <button class="btn btn-success" onclick="uploadExample()" style="width: 100%;" id="exampleSubmitBtn">📤 Upload</button>
        <button class="btn btn-secondary" onclick="cancelEditExample()" style="width: 100%; margin-top: 8px; display: none;" id="exampleCancelBtn">❌ Cancel Edit</button>
      </div>
      <div class="card">
        <div class="card-header">🎵 Your Work Examples</div>
        <div id="examplesDisplay">No examples yet</div>
      </div>
    </div>

    <div id="collaborate" class="tab">
      <div class="card">
        <div class="card-header">🤝 Post Collaboration Request</div>
        <input type="hidden" id="editingCollabIdx" value="" />
        <div class="form-group"><label>🎭 Select Persona *</label><select id="collabPersona" onchange="updateCollabExampleOptions()"><option value="">Choose persona</option></select></div>
        <div class="form-group"><label>🎵 Select Public Example *</label><select id="collabPublicExample"><option value="">Choose example</option></select></div>
        <div class="form-group"><label>📝 Description (200 chars) *</label><textarea id="collabPostDesc" placeholder="What collaboration are you looking for?" style="height: 60px;" maxlength="200"></textarea></div>
        <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border);"><div style="font-weight: 600; font-size: 12px; margin-bottom: 10px; color: var(--primary);">🎯 Collaborator Requirements</div>
          <div class="grid-2"><div class="form-group"><label>👥 Min Age</label><input type="number" id="collabMinAge" min="13" max="120" placeholder="13" /></div><div class="form-group"><label>👥 Max Age</label><input type="number" id="collabMaxAge" min="13" max="120" placeholder="120" /></div></div>
          <div class="grid-2"><div class="form-group"><label>📍 Max Distance (miles)</label><input type="number" id="collabMaxDistance" min="0" placeholder="Unlimited" /></div><div class="form-group"><label>💵 Budget per Collab ($ range)</label><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;"><input type="number" id="collabBudgetMin" min="0" step="0.01" placeholder="Min" /><input type="number" id="collabBudgetMax" min="0" step="0.01" placeholder="Max" /></div><div style="font-size: 10px; color: var(--text-light); margin-top: 4px;">Leave blank for no min/max.</div></div></div>
          <div class="grid-2"><div class="form-group"><label>📊 Min Experience (yrs)</label><input type="number" id="collabMinExp" min="0" step="0.5" placeholder="0" /></div><div class="form-group"><label>⭐ Min Profile Rating</label><input type="number" id="collabMinProfileRating" min="0" max="10" step="0.1" placeholder="0" /></div></div>
          <div class="grid-2"><div class="form-group"><label>📸 Min Picture Rating</label><input type="number" id="collabMinPictureRating" min="0" max="10" step="0.1" placeholder="0" /></div><div class="form-group"><label>⚧️ Preferred Gender</label><select id="collabPreferredGender"><option value="">Any</option><option value="Male">🚹 Male</option><option value="Female">🚺 Female</option><option value="Non-Binary">⚧️ Non-Binary</option></select></div></div></div>
        <button class="btn btn-success" onclick="postCollabRequest()" style="width: 100%;" id="collabSubmitBtn">📤 Post</button>
        <button class="btn btn-secondary" onclick="cancelEditCollab()" style="width: 100%; margin-top: 8px; display: none;" id="collabCancelBtn">❌ Cancel Edit</button>
      </div>
      
      <div class="card">
        <div class="card-header">
          <span>🔍 Filter Requests</span>
          <button class="btn btn-small btn-secondary" onclick="resetFilters()">Reset All</button>
        </div>
        <div class="filter-panel">
          <div class="filter-row">
            <label style="font-weight: 600; font-size: 11px; min-width: 80px;">🎭 Persona:</label>
            <select id="filterPersona" onchange="applyFilters()" style="flex: 1; padding: 6px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); font-size: 11px;">
              <option value="">All Personas</option>
              <option value="🎤 Indie Artist">🎤 Indie Artist</option>
              <option value="🎚️ Beat Producer">🎚️ Beat Producer</option>
              <option value="🎛️ Mix Engineer">🎛️ Mix Engineer</option>
              <option value="🎨 Designer">🎨 Designer</option>
              <option value="🎬 Videographer">🎬 Videographer</option>
            </select>
          </div>
          <div class="filter-row">
            <label style="font-weight: 600; font-size: 11px; min-width: 80px;">📍 Location:</label>
            <input type="text" id="filterLocation" placeholder="City/State" oninput="applyFilters()" style="flex: 1; padding: 6px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); font-size: 11px;" />
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">🗺️ Collaborators Map</div>
        <div class="map-container">
          <div id="collabMap"></div>
        </div>
        <div id="mapUsersListContainer">
          <div style="font-size: 12px; font-weight: 600; margin-bottom: 12px; color: var(--primary);">👥 Nearby Collaborators</div>
          <div id="mapUsersList"></div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <span>💼 Collaboration Feed</span>
          <span class="filter-badge" id="feedCount">0</span>
        </div>
        <div id="collabFeed">No posts yet</div>
      </div>
    </div>

    <div id="profile" class="tab">
      <div class="card">
        <div class="card-header">👤 Your Public Profile</div>
        <div style="text-align: center; padding: 14px; background: var(--bg); border-radius: 8px; margin-bottom: 12px;">
          <div class="avatar-wrapper" style="margin: 0 auto 8px;">
            <div id="pubPic" style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 28px; overflow: hidden;">👤</div>
            <div id="pubRatingBadge" class="rating-badge">⭐ N/A</div>
          </div>
          <div id="pubUsername" style="font-weight: 700; font-size: 14px;">Not Set</div>
          <div id="pubInfo" style="font-size: 11px; color: var(--text-light);"></div>
        </div>
        <div style="background: var(--bg); padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 11px;"><div style="color: var(--text-light); margin-bottom: 4px; font-weight: 600;">📝 Bio:</div><div id="pubBio">No bio</div></div>
        <div style="background: var(--bg); padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 11px;"><div style="color: var(--text-light); margin-bottom: 4px; font-weight: 600;">📧 Email:</div><div id="pubEmail" style="display: flex; gap: 6px; align-items: center;"><span id="pubEmailText">No email</span><button class="btn btn-small btn-secondary" onclick="copyEmail()" id="copyEmailBtn">📋 Copy</button></div></div>
        <div style="background: var(--bg); padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 11px;"><div style="color: var(--text-light); margin-bottom: 4px; font-weight: 600;">🎯 Skills (with experience):</div><div id="pubSkills">No skills</div></div>
      </div>
    </div>

    <div id="money" class="tab">
      <div class="card">
        <div class="card-header">💰 Wallet</div>
        <div class="grid-2">
          <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;"><div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">💵 Balance</div><div style="font-size: 16px; font-weight: 700;" id="walletBalance">$0.00</div></div>
          <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;"><div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">💸 Total Earned</div><div style="font-size: 16px; font-weight: 700;" id="walletEarned">$0.00</div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">💳 Accept Payments with Stripe (Tax Included)</div>
        <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 11px;">
          <strong>🔒 Secure Payments:</strong> Stripe automatically calculates and collects taxes based on customer location
        </div>
        <div class="form-group"><label>💵 Service Amount ($)</label><input type="number" id="serviceAmount" min="1" step="0.01" placeholder="50.00" /></div>
        <div class="form-group"><label>📝 Service Description</label><input type="text" id="serviceDesc" placeholder="Beat production, mixing, etc." /></div>
        <div class="form-group">
          <label>🧾 Tax Handling</label>
          <select id="taxMode">
            <option value="automatic">✨ Automatic (Recommended) - Stripe calculates tax</option>
            <option value="manual">🔧 Manual - Fixed tax rate</option>
            <option value="none">❌ No tax collection</option>
          </select>
        </div>
        <div class="form-group" id="manualTaxDiv" style="display: none;">
          <label>Tax Rate (%)</label>
          <input type="number" id="manualTaxRate" min="0" max="100" step="0.1" value="8.5" />
        </div>
        <button class="btn btn-success" onclick="createStripeCheckout()" style="width: 100%;">💳 Create Payment Link</button>
        <div id="paymentLinkDisplay" style="margin-top: 12px; display: none;">
          <div style="background: var(--success); color: white; padding: 12px; border-radius: 8px; font-size: 11px;">
            <strong>✅ Payment Link Created!</strong><br>
            <a href="#" id="paymentLink" target="_blank" style="color: white; text-decoration: underline; word-break: break-all;"></a>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">➕ Add Income Manually</div>
        <div class="grid-2">
          <div class="form-group"><label>💵 Amount ($)</label><input type="number" id="incomeAmt" min="0" step="1" /></div>
          <div class="form-group"><label>🧾 Tax % (deducted)</label><input type="number" id="incomeTaxRate" min="0" max="100" step="0.1" value="5" /></div>
        </div>
        <button class="btn btn-success" onclick="addIncome()" style="width: 100%;">✓ Add</button>
      </div>
      <div class="card">
        <div class="card-header">📊 Tax Collection Summary</div>
        <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 11px;">
            <span>Total Sales Tax Collected:</span>
            <strong id="totalTaxCollected">$0.00</strong>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 11px;">
            <span>Net Income (after tax):</span>
            <strong id="netIncome">$0.00</strong>
          </div>
        </div>
      </div>
    </div>

    <div id="settings" class="tab">
      <div class="card">
        <div class="card-header">🔐 Account (Password Login)</div>
        <div class="form-group"><label>Username</label><input type="text" id="authUsername" placeholder="Optional display name" /></div>
        <div class="form-group"><label>Email *</label><input type="email" id="authEmail" placeholder="you@email.com" /></div>
        <div class="form-group"><label>Password *</label><input type="password" id="authPassword" placeholder="At least 8 characters" /></div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-success" onclick="registerUser()" id="registerBtn">📝 Register</button>
          <button class="btn" onclick="loginUser()" id="loginBtn">🔓 Login</button>
          <button class="btn btn-secondary" onclick="logoutUser()" id="logoutBtn">🚪 Logout</button>
        </div>
        <div id="authStatus" style="margin-top: 10px; font-size: 11px; color: var(--text-light);">Not logged in</div>
      </div>

      <div class="card">
        <div class="card-header">🎨 Theme Colors</div>
        <div class="theme-selector">
          <button class="theme-color-btn" style="background: #2196F3;" onclick="applyTheme('blue', '#2196F3', '#1565C0')" title="Blue">💙 Blue</button>
          <button class="theme-color-btn" style="background: #FF6B35;" onclick="applyTheme('orange', '#FF6B35', '#E55100')" title="Orange">🧡 Orange</button>
          <button class="theme-color-btn" style="background: #764BA2;" onclick="applyTheme('purple', '#764BA2', '#5E35B1')" title="Purple">💜 Purple</button>
          <button class="theme-color-btn" style="background: #F44336;" onclick="applyTheme('red', '#F44336', '#D32F2F')" title="Red">❤️ Red</button>
          <button class="theme-color-btn" style="background: #00BCD4;" onclick="applyTheme('cyan', '#00BCD4', '#0097A7')" title="Cyan">💎 Cyan</button>
          <button class="theme-color-btn" style="background: #E91E63;" onclick="applyTheme('pink', '#E91E63', '#C2185B')" title="Pink">💖 Pink</button>
          <button class="theme-color-btn" style="background: #4CAF50;" onclick="applyTheme('green', '#4CAF50', '#2E7D32')" title="Green">💚 Green</button>
          <button class="theme-color-btn" style="background: #FF9800;" onclick="applyTheme('amber', '#FF9800', '#F57C00')" title="Amber">🧨 Amber</button>
          <button class="theme-color-btn" style="background: #9C27B0;" onclick="applyTheme('deep-purple', '#9C27B0', '#7B1FA2')" title="Deep Purple">☂️ Deep Purple</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">🌓 Display</div>
        <div class="toggle-setting">
          <div>
            <div style="font-weight: 700;">🌙 Dark Mode</div>
            <div style="font-size: 11px; color: var(--text-light); margin-top: 2px;">Switch between light and dark themes</div>
          </div>
          <div class="toggle-switch" onclick="toggleDarkMode()" id="darkModeToggle">
            <div class="toggle-slider"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">🌍 Language</div>
        <div class="form-group">
          <label>Select Language</label>
          <select id="languageSelect" onchange="changeLanguage(this.value)">
            <option value="English">🇬🇧 English</option>
            <option value="Spanish">🇪🇸 Spanish</option>
            <option value="French">🇫🇷 French</option>
            <option value="German">🇩🇪 German</option>
            <option value="Japanese">🇯🇵 Japanese</option>
          </select>
        </div>
      </div>

      <div class="card">
        <div class="card-header">🔔 Notifications</div>
        <div class="toggle-setting">
          <div>
            <div style="font-weight: 700;">📧 Email Notifications</div>
            <div style="font-size: 11px; color: var(--text-light); margin-top: 2px;">Receive updates via email</div>
          </div>
          <div class="toggle-switch" onclick="toggleNotification('email')" id="emailNotifToggle">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div id="emailVerifSection" style="margin-top: 12px;">
          <button class="btn btn-secondary btn-small" onclick="sendVerificationEmail()" style="width: 100%;">✉️ Send Verification Email</button>
          <div class="verification-status unverified" id="emailVerifStatus">
            <span>❌</span>
            <span>Email not verified</span>
          </div>
        </div>

        <div class="toggle-setting" style="margin-top: 12px;">
          <div>
            <div style="font-weight: 700;">🔊 Push Notifications</div>
            <div style="font-size: 11px; color: var(--text-light); margin-top: 2px;">Browser push notifications</div>
          </div>
          <div class="toggle-switch" onclick="toggleNotification('push')" id="pushNotifToggle">
            <div class="toggle-slider"></div>
          </div>
        </div>

        <div class="toggle-setting" style="margin-top: 12px;">
          <div>
            <div style="font-weight: 700;">📱 SMS Notifications</div>
            <div style="font-size: 11px; color: var(--text-light); margin-top: 2px;">Text message alerts</div>
          </div>
          <div class="toggle-switch" onclick="toggleNotification('phone')" id="phoneNotifToggle">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div id="phoneVerifSection" style="margin-top: 12px;">
          <button class="btn btn-secondary btn-small" onclick="sendVerificationSMS()" style="width: 100%;">📲 Send Verification SMS</button>
          <div class="verification-status unverified" id="phoneVerifStatus">
            <span>❌</span>
            <span>Phone not verified</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">💾 Data Management</div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-secondary" onclick="exportData()">📥 Export Data</button>
          <button class="btn btn-danger" onclick="resetSettings()">🔄 Reset Settings</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="genreModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h2>🎵 Select Music Genre</h2><button class="close-btn" onclick="closeGenreModal()">✕</button></div>
    <div id="genreCats" style="max-height: 400px; overflow-y: auto; margin-bottom: 12px;"></div>
    <div style="display: flex; gap: 10px;"><button class="btn btn-secondary" onclick="closeGenreModal()" style="flex: 1;">Cancel</button><button class="btn btn-success" onclick="addGenre()" style="flex: 1;">✓ Select</button></div>
  </div>
</div>

<div id="skillModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h2 id="skillModalTitle">Select Skills</h2><button class="close-btn" onclick="closeSkillModal()">✕</button></div>
    <input type="hidden" id="editingPersonaIdx" value="" />
    <div style="background: #4caf50; color: white; padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 11px; font-weight: 600;">✨ Click MULTIPLE skills (including "Any" skills), then click "Add Skills" to save them all with the same date and pricing!</div>
    <div class="form-group"><label>📅 Start Date *</label><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"><select id="skillMo"></select><select id="skillDay"></select><select id="skillYr"></select></div></div>
    <div class="form-group"><label>💰 Price Per Work ($)</label><input type="number" id="skillPricePerWork" min="0" step="0.01" placeholder="e.g., 50" /></div>
    <div class="form-group"><label>⏰ Price Per Hour ($)</label><input type="number" id="skillPricePerHour" min="0" step="0.01" placeholder="e.g., 25" /></div>
    <div id="skillCats" style="max-height: 280px; overflow-y: auto; margin-bottom: 12px;"></div>
    <div style="display: flex; gap: 10px;"><button class="btn btn-secondary" onclick="closeSkillModal()" style="flex: 1;">Cancel</button><button class="btn btn-success" onclick="addSkills()" style="flex: 1;" id="skillSubmitBtn">✓ Add Skills</button></div>
  </div>
</div>

<div id="editSkillModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h2>✏️ Edit Skill</h2><button class="close-btn" onclick="closeEditSkillModal()">✕</button></div>
    <input type="hidden" id="editingPersonaIdxForSkill" value="" />
    <input type="hidden" id="editingSkillIdx" value="" />
    <div class="form-group"><label>🎵 Skill Name</label><input type="text" id="editSkillName" placeholder="Skill name" disabled style="background: var(--bg); color: var(--text-light);" /></div>
    <div class="form-group"><label>📅 Start Date *</label><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"><select id="editSkillMo"></select><select id="editSkillDay"></select><select id="editSkillYr"></select></div></div>
    <div class="form-group"><label>💰 Price Per Work ($)</label><input type="number" id="editSkillPricePerWork" min="0" step="0.01" placeholder="e.g., 50" /></div>
    <div class="form-group"><label>⏰ Price Per Hour ($)</label><input type="number" id="editSkillPricePerHour" min="0" step="0.01" placeholder="e.g., 25" /></div>
    <div style="display: flex; gap: 10px;"><button class="btn btn-secondary" onclick="closeEditSkillModal()" style="flex: 1;">Cancel</button><button class="btn btn-success" onclick="updatePersonaSkill()" style="flex: 1;">✓ Save Changes</button></div>
  </div>
</div>

<div id="skillsUsedModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h2>🎯 Choose Skills Used on This Example</h2><button class="close-btn" onclick="closeSkillsUsedModal()">✕</button></div>
    <div style="background: var(--accent); color: white; padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 11px; font-weight: 600;">ℹ️ Click skills to select them. Click "Any" to see specific options. Selected skills update in real-time at the top!</div>
    <div id="skillsUsedCats" style="max-height: 400px; overflow-y: auto; margin-bottom: 12px;"></div>
    <div style="display: flex; gap: 10px;"><button class="btn btn-success" onclick="closeSkillsUsedModal()" style="flex: 1;">✓ Done</button></div>
  </div>
</div>


  <div id="mediaPlayerModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header"><h2 id="mediaPlayerTitle"> Play Work</h2><button class="close-btn" onclick="closeMediaPlayer()"></button></div>
      <div id="mediaPlayerContainer" style="background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 12px; text-align: center;">
        <audio id="audioPlayer" style="width: 100%; margin-bottom: 12px;" controls></audio>
        <video id="videoPlayer" style="width: 100%; max-height: 400px; margin-bottom: 12px; border-radius: 6px; display: none;"></video>
        <div id="mediaMetadata" style="text-align: left; font-size: 11px; color: var(--text-light);"></div>
      </div>
    </div>
  </div>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDummy123456&libraries=places"></script>
  <script>
  function playMedia(idx) {
    const example = appState.examples[idx];
    if (!example || !example.media) { alert('❌ No media found for this work'); return; }
    const audioPlayer = document.getElementById('audioPlayer');
    const videoPlayer = document.getElementById('videoPlayer');
    const mediaTitle = document.getElementById('mediaPlayerTitle');
    const mediaMetadata = document.getElementById('mediaMetadata');
    
    mediaTitle.textContent = ' ' + example.title;
    mediaMetadata.innerHTML = `<strong>Genre:</strong> ${example.genre || 'N/A'}<br><strong>Skills:</strong> ${(example.skills || []).join(', ') || 'N/A'}<br><strong>Uploaded by:</strong> ${example.userName || 'Unknown'} (${example.userLocation || 'Unknown'})`;
    
    // Determine if audio or video
    const isAudio = example.mediaType.startsWith('audio/');
    
    // Show loading state
    const container = document.getElementById('mediaPlayerContainer');
    const originalHTML = container.innerHTML;
    if (isAudio) {
      audioPlayer.style.display = 'block';
      videoPlayer.style.display = 'none';
    } else {
      videoPlayer.style.display = 'block';
      audioPlayer.style.display = 'none';
    }
    
    // Open modal first
    document.getElementById('mediaPlayerModal').classList.add('active');
    
    // Convert base64 data URL to Blob asynchronously to avoid freezing
    setTimeout(() => {
      try {
        const arr = example.media.split(',');
        const mime = arr[0].match(/:(.*?);/)[1] || example.mediaType;
        const bstr = atob(arr[1]);
        const n = bstr.length;
        const u8arr = new Uint8Array(n);
        for (let i = 0; i < n; i++) { u8arr[i] = bstr.charCodeAt(i); }
        const blob = new Blob([u8arr], { type: mime });
        const url = URL.createObjectURL(blob);
        
        if (isAudio) {
          audioPlayer.src = url;
        } else {
          videoPlayer.src = url;
        }
      } catch (e) {
        console.error('Error processing media:', e);
        alert('❌ Error loading media file. It may be corrupted or too large.');
      }
    }, 100);
  }
  
  function closeMediaPlayer() {
    document.getElementById('audioPlayer').pause();
    document.getElementById('audioPlayer').src = '';
    document.getElementById('videoPlayer').pause();
    document.getElementById('videoPlayer').src = '';
    document.getElementById('mediaPlayerModal').classList.remove('active');
  }
const instrumentDatabase = {
  'indie-artist': {
    'String Instruments': {'Any String': 'Any String 🎸','Acoustic Guitar': 'Acoustic Guitar 🎸','Electric Guitar': 'Electric Guitar 🎸','Bass Guitar': 'Bass Guitar 🎸','Ukulele': 'Ukulele 🎸','Banjo': 'Banjo 🎸','Mandolin': 'Mandolin 🎸','Violin': 'Violin 🎻','Viola': 'Viola 🎻','Cello': 'Cello 🎻','Double Bass': 'Double Bass 🎻','Harp': 'Harp 🎵'},
    'Keyboard Instruments': {'Any Keyboard': 'Any Keyboard 🎹','Acoustic Piano': 'Acoustic Piano 🎹','Digital Piano': 'Digital Piano 🎹','Synthesizer': 'Synthesizer 🎹','Organ': 'Organ 🎹','Harpsichord': 'Harpsichord 🎹','Accordion': 'Accordion 🎹'},
    'Percussion Instruments': {'Any Percussion': 'Any Percussion 🥁','Drums (Snare)': 'Drums (Snare) 🥁','Drums (Bass)': 'Drums (Bass) 🥁','Drums (Bongo)': 'Drums (Bongo) 🥁','Cymbals': 'Cymbals 🥁'},
    'Rapping': {'Any Rapping': 'Any Rapping 🎤','Alternative Rap': 'Alternative Rap 🎸','Boom Bap': 'Boom Bap 🥁','Chopper': 'Chopper 🚁','Cloud Rap': 'Cloud Rap ☁️','Conscious Rap': 'Conscious Rap 🧠','Crunk': 'Crunk 🔥','Drill': 'Drill ⚔️','Emo Rap': 'Emo Rap 🖤','G-Funk': 'G-Funk 🌴','Gangsta Rap': 'Gangsta Rap ⛓️','Hardcore Hip Hop': 'Hardcore Hip Hop 🎤','Jazz Rap': 'Jazz Rap 🎷','Mumble Rap': 'Mumble Rap 💤','Old School': 'Old School 📻','Snap': 'Snap 🫰','Trap': 'Trap 🏚️'},
    'Singing': {'Any Singing': 'Any Singing 🎶','Bass': 'Bass 🧔‍♂️','Baritone': 'Baritone 🎙️','Tenor': 'Tenor 🎤','Countertenor': 'Countertenor 🕊️','Contralto': 'Contralto 🎻','Alto': 'Alto 🎶','Mezzo-Soprano': 'Mezzo-Soprano 🌊','Soprano': 'Soprano ☀️'}
  },
  'beat-producer': {
    'Music DAWs': {'Any DAW': 'Any DAW 🎛️','Ableton Live': 'Ableton Live 🎵','Adobe Audition': 'Adobe Audition 🎙️','Audacity': 'Audacity 🎧','Bitwig Studio': 'Bitwig Studio 🎚️','Cakewalk': 'Cakewalk 🎼','Cubase': 'Cubase 🎛️','FL Studio': 'FL Studio 🎚️','GarageBand': 'GarageBand 🎵','Logic Pro': 'Logic Pro 🎵','Luna': 'Luna ☁️','Mixcraft': 'Mixcraft 🎚️','PreSonus Studio One': 'PreSonus Studio One 🎛️','Pro Tools': 'Pro Tools 🎙️','Reason': 'Reason 🎛️','Reaper': 'Reaper 🔧','Studio One': 'Studio One 🎛️','Waveform Pro': 'Waveform Pro 📊'},
    'Production Techniques': {'Any Production': 'Any Production 🎚️','Beat Making': 'Beat Making 🎚️','Sampling': 'Sampling 🎵','Sound Design': 'Sound Design 🎛️','Arrangement': 'Arrangement 🎼','Synthesis': 'Synthesis 🎹'}
  },
  'mix-engineer': {
    'Music DAWs': {'Any DAW': 'Any DAW 🎛️','Ableton Live': 'Ableton Live 🎵','Adobe Audition': 'Adobe Audition 🎙️','Audacity': 'Audacity 🎧','Bitwig Studio': 'Bitwig Studio 🎚️','Cakewalk': 'Cakewalk 🎼','Cubase': 'Cubase 🎛️','FL Studio': 'FL Studio 🎚️','GarageBand': 'GarageBand 🎵','Logic Pro': 'Logic Pro 🎵','Luna': 'Luna ☁️','Mixcraft': 'Mixcraft 🎚️','PreSonus Studio One': 'PreSonus Studio One 🎛️','Pro Tools': 'Pro Tools 🎙️','Reason': 'Reason 🎛️','Reaper': 'Reaper 🔧','Studio One': 'Studio One 🎛️','Waveform Pro': 'Waveform Pro 📊'},
    'Engineering Skills': {'Any Engineering': 'Any Engineering 🎛️','Mixing': 'Mixing 🎛️','Mastering': 'Mastering 🎙️','EQ': 'EQ 📊','Compression': 'Compression 🔧','Reverb/Effects': 'Reverb/Effects ✨'}
  },
  'designer': {
    'Design Software': {'Any Design Software': 'Any Design Software 🎨','Photoshop': 'Adobe Photoshop 🎨','Illustrator': 'Adobe Illustrator 🖌️','Figma': 'Figma 🎯','Canva': 'Canva 🌈','Affinity Designer': 'Affinity Designer ✨','CorelDRAW': 'CorelDRAW 🎨','Sketch': 'Sketch 📐','InDesign': 'Adobe InDesign 📄'},
    'Design Skills': {'Any Design Skill': 'Any Design Skill 🎨','UI/UX Design': 'UI/UX Design 🎯','Graphic Design': 'Graphic Design 🖌️','Branding': 'Branding 🏷️','Layout Design': 'Layout Design 📐','Typography': 'Typography 🔤','Color Theory': 'Color Theory 🌈','Icon Design': 'Icon Design 🎭'}
  },
  'videographer': {
    'Video Software': {'Any Video Software': 'Any Video Software 🎬','Adobe Premiere': 'Adobe Premiere 🎬','DaVinci Resolve': 'DaVinci Resolve 🎞️','Final Cut Pro': 'Final Cut Pro 🎥','Sony Vegas': 'Sony Vegas 📹','Filmora': 'Filmora 🎬','After Effects': 'After Effects ✨','OBS': 'OBS Studio 🔴'},
    'Video Skills': {'Any Video Skill': 'Any Video Skill 🎬','Editing': 'Editing 🎬','Color Grading': 'Color Grading 🎨','Motion Graphics': 'Motion Graphics ✨','Cinematography': 'Cinematography 🎥','Drone Footage': 'Drone Footage 🚁','Lighting': 'Lighting 💡','Sound Design': 'Sound Design 🎙️'}
  }
};

let appState = {
  user: {name: '', email: '', phone: '', birthday: '', gender: '', location: '', bio: '', profilePic: null, lat: null, lng: null, rating: null},
  auth: {loggedIn: false, user: null, guest: true},
  personas: [],
  examples: [],
  collabs: [],
  skillsUsed: [],
  selectedGenre: '',
  selectedSkillsInModal: new Set(),
  wallet: {balance: 0, earned: 0},
  examplePrivacy: 'private',
  currentTab: 'setup',
  filteredCollabs: [],
  map: null,
  userMarkers: [],
  settings: {
    theme: 'blue',
    darkMode: false,
    language: 'English',
    emailNotifications: true,
    pushNotifications: true,
    phoneNotifications: false,
    emailVerified: false,
    phoneVerified: false
  }
};

const apiBase = (() => {
  // Always use localhost:3000 for API calls
  return 'http://localhost:3000';
})();

// Storage helpers to avoid crashes when storage is blocked
const _memoryStorage = {};
function safeStorageSet(key, value) {
  try {
    localStorage.setItem(key, value);
  } catch (e) {
    _memoryStorage[key] = value;
  }
}

function safeStorageGet(key) {
  try {
    return localStorage.getItem(key);
  } catch (e) {
    return _memoryStorage[key] || null;
  }
}

function saveAppState() {
  const stateToSave = JSON.parse(JSON.stringify(appState));
  stateToSave.selectedSkillsInModal = Array.from(appState.selectedSkillsInModal);
  safeStorageSet('musicConnectZState', JSON.stringify(stateToSave));
}

function loadAppState() {
  const saved = safeStorageGet('musicConnectZState');
  if (saved) {
    const loaded = JSON.parse(saved);
    appState = {
      user: loaded.user || appState.user,
      auth: loaded.auth || {loggedIn: false, user: null, guest: true},
      personas: loaded.personas || [],
      examples: loaded.examples || [],
      collabs: loaded.collabs || [],
      skillsUsed: loaded.skillsUsed || [],
      selectedGenre: loaded.selectedGenre || '',
      selectedSkillsInModal: new Set(loaded.selectedSkillsInModal || []),
      wallet: loaded.wallet || {balance: 0, earned: 0},
      examplePrivacy: loaded.examplePrivacy || 'private',
      currentTab: loaded.currentTab || 'setup',
      filteredCollabs: loaded.filteredCollabs || [],
      map: null,
      userMarkers: [],
      settings: loaded.settings || {
        theme: 'blue',
        darkMode: false,
        language: 'English',
        emailNotifications: true,
        pushNotifications: true,
        phoneNotifications: false,
        emailVerified: false,
        phoneVerified: false
      }
    };
  }
  if (appState.user.rating === undefined) { appState.user.rating = null; }
  if (appState.settings.darkMode) {
    document.documentElement.setAttribute('data-theme', 'dark');
  }
  updateAllDisplays();
}

function switchTab(tabName) {
  try {
    console.log('switchTab called:', tabName);
    const tabEl = document.getElementById(tabName);
    if (!tabEl) { console.warn('Tab not found:', tabName); return; }
    
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    tabEl.classList.add('active');
    
    const allButtons = document.querySelectorAll('.tab-btn');
    const tabNames = ['setup', 'personas', 'examples', 'collaborate', 'profile', 'money', 'settings'];
    const tabIdx = tabNames.indexOf(tabName);
    if (tabIdx >= 0 && tabIdx < allButtons.length) {
      allButtons[tabIdx].classList.add('active');
    }
    
    appState.currentTab = tabName;
    safeStorageSet('musicConnectZState', JSON.stringify(appState));
    
    try {
      if (tabName === 'collaborate') { 
        updateCollabPersonaOptions(); 
        renderCollabFeed();
        setTimeout(() => initMap(), 300);
      }
      if (tabName === 'profile') { updateProfileDisplay(); }
    } catch (e) {
      console.error('Tab render error:', e);
    }
    console.log('switchTab completed:', tabName);
  } catch (e) { console.error('switchTab error:', e); }
}

function prevTab() {
  const tabs = ['setup', 'personas', 'examples', 'collaborate', 'profile', 'money', 'settings'];
  const currentIdx = tabs.indexOf(appState.currentTab);
  const newIdx = currentIdx === 0 ? tabs.length - 1 : currentIdx - 1;
  switchTab(tabs[newIdx]);
}

function nextTab() {
  const tabs = ['setup', 'personas', 'examples', 'collaborate', 'profile', 'money', 'settings'];
  const currentIdx = tabs.indexOf(appState.currentTab);
  const newIdx = (currentIdx + 1) % tabs.length;
  switchTab(tabs[newIdx]);
}

function saveProfile() {
  const usernameInput = (document.getElementById('username').value || '').trim();
  const emailInput = (document.getElementById('email').value || '').trim();
  const phoneInput = (document.getElementById('phone').value || '').trim();
  const bioInput = (document.getElementById('bio').value || '').trim();
  const locationInput = (document.getElementById('location').value || '').trim();
  
  if (!usernameInput) {
    alert('⚠️ Please enter a username!');
    return;
  }
  
  appState.user.name = usernameInput;
  appState.user.email = emailInput;
  appState.user.phone = phoneInput;
  appState.user.birthday = document.getElementById('birthday').value;
  appState.user.gender = document.getElementById('gender').value;
  appState.user.location = locationInput;
  appState.user.bio = bioInput;
  
  saveAppState();
  updateProfileDisplay();
  alert('✓ Profile saved!\n\nUsername: ' + usernameInput + '\nEmail: ' + emailInput + '\nLocation: ' + locationInput);
}

function loadProfilePic(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => { appState.user.profilePic = e.target.result; document.getElementById('headerPic').innerHTML = `<img src="${e.target.result}" />`; saveAppState(); updateProfileDisplay(); };
    reader.readAsDataURL(file);
  }
}

function reverseGeocode(lat, lng, callback) {
  try {
    if (typeof google === 'undefined' || !google.maps || !google.maps.Geocoder) {
      reverseGeocodeFallback(lat, lng, callback);
      return;
    }
    const geocoder = new google.maps.Geocoder();
    const latlng = { lat: lat, lng: lng };
    geocoder.geocode({ location: latlng }, (results, status) => {
      try {
        if (status === 'OK' && results[0]) {
          const components = {};
          results[0].address_components.forEach(comp => {
            if (comp.types.includes('locality')) components.city = comp.long_name;
            if (comp.types.includes('administrative_area_level_1')) components.state = comp.short_name;
            if (comp.types.includes('country')) components.country = comp.short_name;
          });
          const cityStateCountry = `${components.city || 'Unknown'}, ${components.state || 'Unknown'}, ${components.country || 'Unknown'}`;
          callback(cityStateCountry);
        } else {
          reverseGeocodeFallback(lat, lng, callback);
        }
      } catch (e) {
        reverseGeocodeFallback(lat, lng, callback);
      }
    });
  } catch (e) {
    reverseGeocodeFallback(lat, lng, callback);
  }
}

function calculateExperienceYears(startDateStr) {
  const parsed = new Date(startDateStr);
  if (isNaN(parsed.getTime())) return 'Unknown exp';
  const diffMs = Date.now() - parsed.getTime();
  const years = diffMs / (1000 * 60 * 60 * 24 * 365.25);
  if (years < 0) return '0 yrs';
  return `${years.toFixed(1)} yrs`;
}

function reverseGeocodeFallback(lat, lng, callback) {
  // Fallback using OpenStreetMap Nominatim when Google Maps is unavailable
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 5000);
  fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`, {
    headers: { 'Accept': 'application/json' },
    signal: controller.signal
  }).then(res => res.ok ? res.json() : Promise.reject(new Error('reverse geocode failed')))
    .then(data => {
      clearTimeout(timeoutId);
      const addr = data.address || {};
      const city = addr.city || addr.town || addr.village || addr.hamlet;
      const state = addr.state || addr.region || addr.county;
      const country = addr.country_code ? addr.country_code.toUpperCase() : (addr.country || '');
      const loc = [city, state, country].filter(Boolean).join(', ') || data.display_name || `${lat}, ${lng}`;
      callback(loc);
    })
    .catch(() => { clearTimeout(timeoutId); callback(null); });
}

function computeUserRating() {
  const username = appState.user.name || 'Anonymous';
  const allRatings = appState.collabs
    .filter(c => (c.userName || 'Anonymous') === username)
    .flatMap(c => c.ratings || [])
    .filter(n => typeof n === 'number' && !isNaN(n));
  if (allRatings.length === 0) return null;
  const avg = allRatings.reduce((a, b) => a + b, 0) / allRatings.length;
  const clamped = Math.min(10, Math.max(0, avg));
  return parseFloat(clamped.toFixed(1));
}

function requestGPS() {
  const status = document.getElementById('gpsStatus');
  if (!status) return;
  status.classList.add('active');
  status.textContent = 'Requesting location...';

  // Quick diagnostics so the user knows why the browser may not prompt
  const secure = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  if (!secure) {
    status.textContent = `⚠️ GPS may be blocked on insecure origins (${location.protocol}//${location.hostname}). Use http://localhost:8000.`;
    alert('GPS can be blocked on non-HTTPS origins. Please use http://localhost:8000 for local testing.');
  }

  if (navigator.permissions && navigator.permissions.query) {
    navigator.permissions.query({ name: 'geolocation' }).then((p) => {
      status.textContent = `Geolocation permission: ${p.state}`;
      if (p.state === 'denied') {
        status.textContent = '✗ GPS permission denied (check browser site settings)';
      }
    }).catch(() => {});
  }

  if (!navigator.geolocation) {
    status.textContent = '✗ Geolocation not supported by this browser';
    return;
  }

  const handleError = (err) => {
    let msg = '✗ GPS denied or unavailable';
    if (err) {
      if (err.code === err.PERMISSION_DENIED) msg = '✗ GPS permission denied';
      else if (err.code === err.POSITION_UNAVAILABLE) msg = '✗ GPS unavailable';
      else if (err.code === err.TIMEOUT) msg = '✗ GPS timed out';
    }
    status.textContent = msg;
  };

  navigator.geolocation.getCurrentPosition((pos) => {
    const lat = pos.coords.latitude.toFixed(4);
    const lng = pos.coords.longitude.toFixed(4);
    appState.user.lat = parseFloat(lat);
    appState.user.lng = parseFloat(lng);
    status.textContent = '✓ Getting location...';

    const hasGeocoder = typeof google !== 'undefined' && google.maps && google.maps.Geocoder;
    const finish = (text, msg) => {
      document.getElementById('location').value = text;
      appState.user.location = text;
      status.textContent = msg || `✓ GPS: ${text}`;
    };

    const tryFallback = () => {
      reverseGeocodeFallback(parseFloat(lat), parseFloat(lng), (loc) => {
        if (loc && loc.trim()) { 
          finish(loc, `✓ GPS: ${loc}`); 
        }
        else { 
          finish('Location set (coords saved)', '✓ GPS: Please enter city/state manually for better results');
        }
      });
    };

    if (hasGeocoder) {
      let finished = false;
      const timeoutId = setTimeout(() => {
        if (finished) return;
        finished = true;
        tryFallback();
      }, 5000);

      try {
        reverseGeocode(parseFloat(lat), parseFloat(lng), (location) => {
          if (finished) return;
          finished = true;
          clearTimeout(timeoutId);
          if (location) { finish(location, `✓ GPS: ${location}`); }
          else { tryFallback(); }
        });
      } catch (e) {
        clearTimeout(timeoutId);
        tryFallback();
      }
    } else {
      tryFallback();
    }
  }, handleError, { enableHighAccuracy: true, timeout: 10000 });
}

function updateProfileDisplay() {
  const user = appState.user;
  document.getElementById('pubUsername').textContent = user.name || 'Not Set';
  document.getElementById('pubInfo').innerHTML = `📧 ${user.email || 'No email'}<br>📱 ${user.phone || 'No phone'}<br>📍 ${user.location || 'No location'}`;
  document.getElementById('pubBio').textContent = user.bio || 'No bio';
  document.getElementById('pubEmailText').textContent = user.email || 'No email';
  if (user.email) { document.getElementById('copyEmailBtn').style.display = 'block'; } else { document.getElementById('copyEmailBtn').style.display = 'none'; }
  if (user.profilePic) { document.getElementById('pubPic').innerHTML = `<img src="${user.profilePic}" />`; document.getElementById('headerPic').innerHTML = `<img src="${user.profilePic}" />`; }
  const avgRating = computeUserRating();
  document.getElementById('pubRatingBadge').textContent = avgRating !== null ? `⭐ ${avgRating}` : '⭐ N/A';
  const skillsList = appState.personas.map(p => p.skills.map(s => ({ name: s.name, startDate: s.startDate })) ).flat();
  document.getElementById('pubSkills').innerHTML = skillsList.length > 0 ? skillsList.map(s => `<span class="tag">${s.name} • ${calculateExperienceYears(s.startDate)}</span>`).join('') : 'No skills';
}

function openSkillModal(personaKey, personaName) {
  document.getElementById('skillModalTitle').textContent = `Add Skills - ${personaName}`;
  document.getElementById('editingPersonaIdx').value = personaKey;
  appState.selectedSkillsInModal = new Set();
  renderSkillModal(personaKey);
  populateDateSelects();
  document.getElementById('skillModal').classList.add('active');
}

function populateDateSelects() {
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  const moSelect = document.getElementById('skillMo');
  moSelect.innerHTML = '';
  months.forEach((m, i) => moSelect.innerHTML += `<option value="${i+1}">${m}</option>`);
  const daySelect = document.getElementById('skillDay');
  daySelect.innerHTML = '';
  for (let i = 1; i <= 31; i++) daySelect.innerHTML += `<option value="${i}">${i}</option>`;
  const yrSelect = document.getElementById('skillYr');
  yrSelect.innerHTML = '';
  const currentYear = new Date().getFullYear();
  for (let i = currentYear; i >= 2000; i--) yrSelect.innerHTML += `<option value="${i}">${i}</option>`;
}

function renderSkillModal(personaKey) {
  const skillCats = document.getElementById('skillCats');
  skillCats.innerHTML = '';
  const categories = instrumentDatabase[personaKey];
  if (!categories) {
    skillCats.innerHTML = '<div style="color: red; padding: 10px;">❌ Error: Skills database not found for this persona. Please refresh the page.</div>';
    return;
  }
  for (const [catName, skills] of Object.entries(categories)) {
    const catDiv = document.createElement('div');
    catDiv.style.marginBottom = '14px';
    catDiv.innerHTML = `<div style="font-weight: 700; font-size: 12px; margin-bottom: 8px; color: var(--primary);">${catName}</div><div class="skill-grid"></div>`;
    for (const [skillKey, skillName] of Object.entries(skills)) {
      const isAny = skillKey.toLowerCase().includes('any');
      const btn = document.createElement('button');
      btn.className = `skill-btn ${isAny ? 'any-skill' : ''}`;
      btn.textContent = skillName;
      btn.onclick = (e) => { e.preventDefault(); btn.classList.toggle('sel'); if (btn.classList.contains('sel')) { appState.selectedSkillsInModal.add(skillName); } else { appState.selectedSkillsInModal.delete(skillName); } };
      catDiv.querySelector('.skill-grid').appendChild(btn);
    }
    skillCats.appendChild(catDiv);
  }
}

function addSkills() {
  const personaKey = document.getElementById('editingPersonaIdx').value;
  if (appState.selectedSkillsInModal.size === 0) { alert('❌ Please select at least one skill'); return; }
  const mo = document.getElementById('skillMo').value;
  const day = document.getElementById('skillDay').value;
  const yr = document.getElementById('skillYr').value;
  const startDate = `${mo}/${day}/${yr}`;
  const pricePerWork = parseFloat(document.getElementById('skillPricePerWork').value) || null;
  const pricePerHour = parseFloat(document.getElementById('skillPricePerHour').value) || null;
  const personaNames = { 'indie-artist': '🎤 Indie Artist', 'beat-producer': '🎚️ Beat Producer', 'mix-engineer': '🎛️ Mix Engineer', 'designer': '🎨 Designer', 'videographer': '🎬 Videographer' };
  let persona = appState.personas.find(p => p.key === personaKey);
  if (!persona) { persona = {key: personaKey, name: personaNames[personaKey], skills: []}; appState.personas.push(persona); }
  const skillCount = appState.selectedSkillsInModal.size;
  appState.selectedSkillsInModal.forEach(skillName => { persona.skills.push({name: skillName, startDate: startDate, pricePerWork: pricePerWork, pricePerHour: pricePerHour}); });
  appState.selectedSkillsInModal.clear();
  document.getElementById('skillPricePerWork').value = '';
  document.getElementById('skillPricePerHour').value = '';
  renderPersonasDisplay();
  closeSkillModal();
  saveAppState();
  const priceInfo = [];
  if (pricePerWork) priceInfo.push(`$${pricePerWork}/work`);
  if (pricePerHour) priceInfo.push(`$${pricePerHour}/hr`);
  const priceMsg = priceInfo.length > 0 ? ` (${priceInfo.join(', ')})` : '';
  alert(`✓ Added ${skillCount} skill${skillCount !== 1 ? 's' : ''} with start date ${startDate}${priceMsg}`);
}

function renderPersonasDisplay() {
  try {
    const display = document.getElementById('personasDisplay');
    if (!display) return;
    if (appState.personas.length === 0) { display.innerHTML = 'No personas yet'; return; }
    display.innerHTML = '';
    appState.personas.forEach((persona, idx) => {
      try {
        const card = document.createElement('div');
        card.className = 'persona-card';
        card.innerHTML = `<div class="persona-header"><div class="persona-name">${persona.name}</div><button class="btn btn-danger btn-small" onclick="removePersona(${idx})">Remove</button></div><div style="font-size: 11px;"><div style="font-weight: 600; margin-bottom: 6px;">Skills:</div><div id="personaSkills${idx}"></div></div>`;
        display.appendChild(card);
        const skillsDiv = document.getElementById(`personaSkills${idx}`);
        if (persona.skills && Array.isArray(persona.skills)) {
          persona.skills.forEach((skill, sIdx) => {
            try {
              const skillItem = document.createElement('div');
              skillItem.className = 'skill-item';
              const priceInfo = [];
              if (skill.pricePerWork) priceInfo.push(`$${skill.pricePerWork}/work`);
              if (skill.pricePerHour) priceInfo.push(`$${skill.pricePerHour}/hr`);
              const priceDisplay = priceInfo.length > 0 ? ` • ${priceInfo.join(', ')}` : '';
              skillItem.innerHTML = `<span class="skill-item-name">${skill.name}</span><span class="skill-item-exp">${skill.startDate}${priceDisplay}</span><div class="skill-item-actions"><button class="btn btn-primary btn-small" onclick="openEditSkillModal(${idx}, ${sIdx})" style="font-size: 10px;">✏️</button><button class="btn btn-danger btn-small" onclick="removePersonaSkill(${idx}, ${sIdx})">✕</button></div>`;
              skillsDiv.appendChild(skillItem);
            } catch (e) {
              console.error('Error rendering skill:', e);
            }
          });
        }
      } catch (e) {
        console.error('Error rendering persona:', e);
      }
    });
    try {
      updateProfileDisplay();
    } catch (e) {
      console.error('Error in updateProfileDisplay:', e);
    }
  } catch (e) {
    console.error('renderPersonasDisplay error:', e);
  }
}

function removePersona(idx) { if (confirm('Remove this persona and all its skills?')) { appState.personas.splice(idx, 1); renderPersonasDisplay(); saveAppState(); } }

function removePersonaSkill(personaIdx, skillIdx) { 
  try {
    if (appState.personas[personaIdx] && appState.personas[personaIdx].skills) {
      appState.personas[personaIdx].skills.splice(skillIdx, 1); 
      renderPersonasDisplay(); 
      saveAppState(); 
    }
  } catch (e) {
    console.error('removePersonaSkill error:', e);
  }
}

function openEditSkillModal(personaIdx, skillIdx) {
  try {
    const skill = appState.personas[personaIdx].skills[skillIdx];
    const [month, day, year] = skill.startDate.split('/');
    
    document.getElementById('editingPersonaIdxForSkill').value = personaIdx;
    document.getElementById('editingSkillIdx').value = skillIdx;
    document.getElementById('editSkillName').value = skill.name;
    document.getElementById('editSkillMo').value = month;
    document.getElementById('editSkillDay').value = day;
    document.getElementById('editSkillYr').value = year;
    document.getElementById('editSkillPricePerWork').value = skill.pricePerWork || '';
    document.getElementById('editSkillPricePerHour').value = skill.pricePerHour || '';
    
    // Populate date select options
    populateEditDateSelects();
    document.getElementById('editSkillModal').classList.add('active');
  } catch (e) {
    console.error('openEditSkillModal error:', e);
  }
}

function populateEditDateSelects() {
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  const moSelect = document.getElementById('editSkillMo');
  moSelect.innerHTML = '';
  months.forEach((m, i) => moSelect.innerHTML += `<option value="${i+1}">${m}</option>`);
  const daySelect = document.getElementById('editSkillDay');
  daySelect.innerHTML = '';
  for (let i = 1; i <= 31; i++) daySelect.innerHTML += `<option value="${i}">${i}</option>`;
  const yrSelect = document.getElementById('editSkillYr');
  yrSelect.innerHTML = '';
  const currentYear = new Date().getFullYear();
  for (let i = currentYear; i >= 2000; i--) yrSelect.innerHTML += `<option value="${i}">${i}</option>`;
}

function updatePersonaSkill() {
  const personaIdx = parseInt(document.getElementById('editingPersonaIdxForSkill').value);
  const skillIdx = parseInt(document.getElementById('editingSkillIdx').value);
  const skill = appState.personas[personaIdx].skills[skillIdx];
  
  const mo = document.getElementById('editSkillMo').value;
  const day = document.getElementById('editSkillDay').value;
  const yr = document.getElementById('editSkillYr').value;
  
  skill.startDate = `${mo}/${day}/${yr}`;
  skill.pricePerWork = parseFloat(document.getElementById('editSkillPricePerWork').value) || null;
  skill.pricePerHour = parseFloat(document.getElementById('editSkillPricePerHour').value) || null;
  
  renderPersonasDisplay();
  closeEditSkillModal();
  saveAppState();
  alert('✓ Skill updated successfully!');
}

function closeEditSkillModal() { document.getElementById('editSkillModal').classList.remove('active'); }

function closeSkillModal() { document.getElementById('skillModal').classList.remove('active'); }

function openGenreModal() {
  const genreCats = document.getElementById('genreCats');
  genreCats.innerHTML = '';
  const genres = ['Blues', 'Brass & Military', 'Children\'s', 'Classical', 'Country', 'Electronic', 'Folk', 'Funk / Soul', 'Hip-Hop', 'House', 'International', 'Jazz', 'Latin', 'Newage', 'Non-Music', 'Pop', 'Pop/Rock', 'R&B', 'Reggae', 'Religious', 'Rock', 'Rap', 'Soul', 'Soundtrack', 'Techno', 'Traditional', 'World'];
  genres.forEach(genre => {
    const btn = document.createElement('button');
    btn.className = `genre-btn ${appState.selectedGenre === genre ? 'sel' : ''}`;
    btn.textContent = genre;
    btn.onclick = () => { document.querySelectorAll('#genreCats .genre-btn').forEach(b => b.classList.remove('sel')); btn.classList.add('sel'); appState.selectedGenre = genre; };
    genreCats.appendChild(btn);
  });
  document.getElementById('genreModal').classList.add('active');
}

function closeGenreModal() { document.getElementById('genreModal').classList.remove('active'); }

function addGenre() { if (!appState.selectedGenre) { alert('❌ Please select a genre'); return; } document.getElementById('exampleGenreDisplay').textContent = appState.selectedGenre; closeGenreModal(); }

function findCategoryForSkill(personaKey, skillName) {
  const personaDb = instrumentDatabase[personaKey];
  if (!personaDb) return null;
  for (const [catName, skillsObj] of Object.entries(personaDb)) {
    for (const val of Object.values(skillsObj)) { if (val === skillName) return catName; }
  }
  return null;
}

function openSpecificSkillsFromAny(personaKey, anySkillName) {
  const categoryName = findCategoryForSkill(personaKey, anySkillName);
  if (!categoryName) { alert('❌ Could not find specific skills for this category.'); return; }
  const personaDb = instrumentDatabase[personaKey];
  const skillsObj = personaDb[categoryName];
  const skillsUsedCats = document.getElementById('skillsUsedCats');
  skillsUsedCats.innerHTML = '';
  
    // Re-add the realtime selected skills display
    const selectedDisplay = document.createElement('div');
    selectedDisplay.id = 'realtimeSkillsDisplay';
    selectedDisplay.style.cssText = 'background: var(--success); color: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 11px; font-weight: 600; min-height: 40px; display: flex; align-items: center; flex-wrap: wrap; gap: 6px;';
    selectedDisplay.innerHTML = appState.skillsUsed.length > 0 ? appState.skillsUsed.map(s => `<span style="background: rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 4px;">${s} <button onclick="removeSkillFromUsed('${s.replace(/'/g, "\\'")}'); return false;" style="background: none; border: none; color: white; cursor: pointer; margin-left: 4px; font-weight: bold;">✕</button></span>`).join('') : '✨ Select skills below...';
    skillsUsedCats.appendChild(selectedDisplay);
  
  const catDiv = document.createElement('div');
  catDiv.style.marginBottom = '14px';
  catDiv.innerHTML = `<div style="font-weight: 700; font-size: 12px; margin-bottom: 8px; color: var(--primary);">✨ ${categoryName} – select specific skill</div><div class="skill-grid"></div><div style="margin-top: 8px;"><button class="btn btn-secondary" onclick="openSkillsUsedModal()" style="width: 100%;">← Back to Categories</button></div>`;
  Object.entries(skillsObj).forEach(([skillKey, skillLabel]) => {
    if (skillKey.toLowerCase().includes('any')) return;
    const btn = document.createElement('button');
    btn.className = `skill-btn ${appState.skillsUsed.includes(skillLabel) ? 'sel' : ''}`;
    btn.textContent = skillLabel;
    btn.onclick = (e) => {
      e.preventDefault();
      if (!appState.skillsUsed.includes(skillLabel)) {
        appState.skillsUsed.push(skillLabel);
        btn.classList.add('sel');
        updateRealtimeSkillsDisplay();
        saveAppState();
      } else {
        appState.skillsUsed = appState.skillsUsed.filter(s => s !== skillLabel);
        btn.classList.remove('sel');
        updateRealtimeSkillsDisplay();
        saveAppState();
      }
    };
    catDiv.querySelector('.skill-grid').appendChild(btn);
  });
  skillsUsedCats.appendChild(catDiv);
}

function openSkillsUsedModal() {
  if (appState.personas.length === 0) { alert('❌ You need to add personas and skills first!\n\nSteps:\n1. Go to PERSONAS tab\n2. Click a persona (🎤 Indie, 🎚️ Producer, etc.)\n3. Select skills and set a start date\n4. Click "✓ Add Skills"\n\nThen come back here.'); return; }
  const skillsUsedCats = document.getElementById('skillsUsedCats');
  skillsUsedCats.innerHTML = '';
  
  // Add real-time selected skills display
  const selectedDisplay = document.createElement('div');
  selectedDisplay.id = 'realtimeSkillsDisplay';
  selectedDisplay.style.cssText = 'background: var(--success); color: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 11px; font-weight: 600; min-height: 40px; display: flex; align-items: center; flex-wrap: wrap; gap: 6px;';
  selectedDisplay.innerHTML = appState.skillsUsed.length > 0 ? appState.skillsUsed.map(s => `<span style="background: rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 4px;">${s} <button onclick="removeSkillFromUsed('${s.replace(/'/g, "\\'")}'); return false;" style="background: none; border: none; color: white; cursor: pointer; margin-left: 4px; font-weight: bold;">✕</button></span>`).join('') : '✨ Select skills below...';
  skillsUsedCats.appendChild(selectedDisplay);
  
  appState.personas.forEach(persona => {
    const catDiv = document.createElement('div');
    catDiv.style.marginBottom = '14px';
    catDiv.innerHTML = `<div style="font-weight: 700; font-size: 12px; margin-bottom: 8px; color: var(--primary);">${persona.name}</div><div class="skill-grid"></div>`;
    persona.skills.forEach(skill => {
      const isAny = skill.name.toLowerCase().includes('any');
      const btn = document.createElement('button');
      btn.className = `skill-btn ${isAny ? 'any-skill' : ''} ${appState.skillsUsed.includes(skill.name) ? 'sel' : ''}`;
      btn.textContent = skill.name;
      btn.onclick = (e) => {
        e.preventDefault();
        if (isAny) { openSpecificSkillsFromAny(persona.key, skill.name); } else {
          if (!appState.skillsUsed.includes(skill.name)) {
            appState.skillsUsed.push(skill.name);
            btn.classList.add('sel');
          } else {
            appState.skillsUsed = appState.skillsUsed.filter(s => s !== skill.name);
            btn.classList.remove('sel');
          }
          updateRealtimeSkillsDisplay();
          saveAppState();
        }
      };
      catDiv.querySelector('.skill-grid').appendChild(btn);
    });
    skillsUsedCats.appendChild(catDiv);
  });
  document.getElementById('skillsUsedModal').classList.add('active');
}

function updateSkillsUsedDisplay() {
  const display = document.getElementById('skillsUsedDisplay');
  if (appState.skillsUsed.length === 0) { display.textContent = 'Click to select skills used'; } else { display.innerHTML = appState.skillsUsed.map(s => `<span class="tag">${s}</span>`).join(''); }
}

function updateRealtimeSkillsDisplay() {
  const realtimeDisplay = document.getElementById('realtimeSkillsDisplay');
  if (realtimeDisplay) {
    realtimeDisplay.innerHTML = appState.skillsUsed.length > 0 ? appState.skillsUsed.map(s => `<span style="background: rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 4px;">${s} <button onclick="removeSkillFromUsed('${s.replace(/'/g, "\\'")}'); return false;" style="background: none; border: none; color: white; cursor: pointer; margin-left: 4px; font-weight: bold;">✕</button></span>`).join('') : '✨ Select skills below...';
  }
  updateSkillsUsedDisplay();
}

function removeSkillFromUsed(skillName) {
  appState.skillsUsed = appState.skillsUsed.filter(s => s !== skillName);
  updateRealtimeSkillsDisplay();
  saveAppState();
  // Update button states in the modal
  document.querySelectorAll('#skillsUsedCats .skill-btn').forEach(btn => {
    if (btn.textContent.trim() === skillName.trim()) btn.classList.remove('sel');
  });
}

function closeSkillsUsedModal() { 
  updateSkillsUsedDisplay(); 
  saveAppState(); 
  document.getElementById('skillsUsedModal').classList.remove('active'); 
}

function setExamplePrivacy(privacy) {
  appState.examplePrivacy = privacy;
  document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`button[onclick="setExamplePrivacy('${privacy}')"]`).classList.add('active');
}

function uploadExample() {
  const title = document.getElementById('exampleTitle').value.trim();
  const desc = document.getElementById('exampleDesc').value.trim();
  const mediaFile = document.getElementById('exampleMedia').files[0];
  if (!title || !desc || !appState.selectedGenre || !mediaFile || appState.skillsUsed.length === 0) { 
    let msg = '❌ VALIDATION ERROR: Fill all required fields:\n';
    if (!title) msg += '- Title\n';
    if (!desc) msg += '- Description\n';
    if (!appState.selectedGenre) msg += '- Genre\n';
    if (!mediaFile) msg += '- Media File\n';
    if (appState.skillsUsed.length === 0) msg += '- At least one skill (click "📋 Select Skills Used" button)\n\nDid you add personas and skills in the PERSONAS tab?';
    alert(msg);
    return;
  }
  const reader = new FileReader();
  reader.onload = (e) => {
    const example = { id: Date.now(), title: title, desc: desc, genre: appState.selectedGenre, media: e.target.result, mediaName: mediaFile.name, mediaType: mediaFile.type, skills: [...appState.skillsUsed], privacy: appState.examplePrivacy, image: null, timestamp: new Date().toLocaleString(), userName: appState.user.name || 'Anonymous', userPic: appState.user.profilePic || null, userLocation: appState.user.location || 'Unknown' };
    const imageFile = document.getElementById('exampleImage').files[0];
    if (imageFile) {
      const imgReader = new FileReader();
      imgReader.onload = (imgE) => { example.image = imgE.target.result; finalizeExample(example); };
      imgReader.readAsDataURL(imageFile);
    } else {
      finalizeExample(example);
    }
  };
  reader.readAsDataURL(mediaFile);
}

function finalizeExample(example) {
  const editIdx = document.getElementById('editingExampleIdx').value;
  if (editIdx) { appState.examples[parseInt(editIdx)] = example; alert('✓ Example updated!'); } else { appState.examples.push(example); alert('✓ Example uploaded!'); }
  appState.skillsUsed = [];
  appState.selectedGenre = '';
  document.getElementById('exampleTitle').value = '';
  document.getElementById('exampleDesc').value = '';
  document.getElementById('exampleMedia').value = '';
  document.getElementById('exampleImage').value = '';
  document.getElementById('exampleGenreDisplay').textContent = 'Click "Select Genre"';
  updateSkillsUsedDisplay();
  cancelEditExample();
  renderExamplesDisplay();
  saveAppState();
}

function renderExamplesDisplay() {
  try {
    const display = document.getElementById('examplesDisplay');
    if (!display) return;
    if (appState.examples.length === 0) { display.innerHTML = 'No examples yet'; return; }
    display.innerHTML = '';
    appState.examples.forEach((example, idx) => {
      try {
        const card = document.createElement('div');
        card.className = 'post-card';
        card.innerHTML = `<div class="post-header"><div class="post-avatar" ${example.userPic ? `style="background-image: url('${example.userPic}'); background-size: cover; background-position: center;"` : ''}>${!example.userPic ? '🎵' : ''}</div><div class="post-info" style="flex: 1;"><div class="post-user">${example.userName}</div><div class="post-meta">${example.timestamp} • ${example.privacy === 'public' ? '🌐 Public' : '🔒 Private'}</div><div class="post-meta">📍 ${example.userLocation}</div></div><button class="btn btn-danger btn-small" onclick="removeExample(${idx})">Delete</button></div><div style="margin-bottom: 8px;"><div style="font-weight: 700; font-size: 12px; margin-bottom: 4px;">🎯 ${example.title}</div><div style="font-size: 11px; color: var(--text-light); margin-bottom: 6px;">${example.desc}</div><div style="font-size: 10px; margin-bottom: 6px;"><span style="background: var(--bg); padding: 2px 6px; border-radius: 4px; margin-right: 4px;">🎵 ${example.genre}</span>${example.skills.map(s => `<span style="background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; margin-right: 2px; display: inline-block;">${s}</span>`).join('')}</div>${example.image ? `<div style="margin: 8px 0; position: relative; display: inline-block; width: 100%;"><img src="${example.image}" style="max-width: 100%; height: auto; border-radius: 6px;"/><button class="btn btn-success" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; padding: 12px 16px; border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; background: rgba(76, 175, 80, 0.9);" onclick="playMedia(${idx})" title="Play">▶️</button></div>` : `<div style="background: var(--bg); padding: 20px; border-radius: 6px; text-align: center; margin: 8px 0;"><button class="btn btn-success" onclick="playMedia(${idx})" style="font-size: 24px;">▶️ Play Media</button></div>`}</div><div class="post-actions"><button class="btn btn-secondary btn-small" onclick="editExample(${idx})">✏️ Edit</button></div>`;
        display.appendChild(card);
      } catch (e) {
        console.error('Error rendering example:', e);
      }
    });
  } catch (e) {
    console.error('renderExamplesDisplay error:', e);
  }
}

function editExample(idx) {
  const example = appState.examples[idx];
  document.getElementById('exampleTitle').value = example.title;
  document.getElementById('exampleDesc').value = example.desc;
  document.getElementById('exampleGenreDisplay').textContent = example.genre;
  appState.selectedGenre = example.genre;
  appState.skillsUsed = [...example.skills];
  updateSkillsUsedDisplay();
  setExamplePrivacy(example.privacy);
  document.getElementById('editingExampleIdx').value = idx;
  document.getElementById('exampleSubmitBtn').textContent = '✏️ Update';
  document.getElementById('exampleCancelBtn').style.display = 'block';
  document.getElementById('currentMediaDisplay').textContent = `Current: ${example.mediaName}`;
  document.getElementById('exampleMedia').value = '';
  switchTab('examples');
}

function cancelEditExample() {
  document.getElementById('editingExampleIdx').value = '';
  document.getElementById('exampleSubmitBtn').textContent = '📤 Upload';
  document.getElementById('exampleCancelBtn').style.display = 'none';
  document.getElementById('currentMediaDisplay').textContent = '';
  appState.examplePrivacy = 'private';
  setExamplePrivacy('private');
}

function removeExample(idx) { if (confirm('Delete this example?')) { appState.examples.splice(idx, 1); renderExamplesDisplay(); saveAppState(); } }

function updateCollabPersonaOptions() {
  const select = document.getElementById('collabPersona');
  select.innerHTML = '<option value="">Choose persona</option>';
  appState.personas.forEach((persona, idx) => { select.innerHTML += `<option value="${idx}">${persona.name}</option>`; });
}

function updateCollabExampleOptions() {
  const personaIdx = document.getElementById('collabPersona').value;
  const exampleSelect = document.getElementById('collabPublicExample');
  exampleSelect.innerHTML = '<option value="">Choose example</option>';
  if (personaIdx !== '') {
    const personaKey = appState.personas[parseInt(personaIdx)].key;
    const publicExamples = appState.examples.filter(ex => ex.privacy === 'public' && ex.skills.some(s => {
      const skillPersona = Object.keys(instrumentDatabase).find(key => { const cats = instrumentDatabase[key]; return Object.values(cats).some(cat => Object.values(cat).includes(s)); });
      return skillPersona === personaKey;
    }));
    publicExamples.forEach((ex, idx) => { exampleSelect.innerHTML += `<option value="${idx}">${ex.title}</option>`; });
  }
}

function postCollabRequest() {
  const personaIdx = document.getElementById('collabPersona').value;
  const exampleIdx = document.getElementById('collabPublicExample').value;
  const desc = document.getElementById('collabPostDesc').value.trim();
  if (!personaIdx || !exampleIdx || !desc) { alert('❌ Please fill all fields'); return; }
  const minAge = parseInt(document.getElementById('collabMinAge').value) || 13;
  const maxAge = parseInt(document.getElementById('collabMaxAge').value) || 120;
  const maxDist = parseFloat(document.getElementById('collabMaxDistance').value) || null;
  const budgetMinRaw = document.getElementById('collabBudgetMin').value;
  const budgetMaxRaw = document.getElementById('collabBudgetMax').value;
  const budgetMin = budgetMinRaw === '' ? null : parseFloat(budgetMinRaw);
  const budgetMax = budgetMaxRaw === '' ? null : parseFloat(budgetMaxRaw);
  const minExp = parseFloat(document.getElementById('collabMinExp').value) || 0;
  const minProfileRating = parseFloat(document.getElementById('collabMinProfileRating').value) || 0;
  const minPictureRating = parseFloat(document.getElementById('collabMinPictureRating').value) || 0;
  const prefGender = document.getElementById('collabPreferredGender').value || '';
  if (minAge > maxAge) { alert('❌ Minimum age cannot be greater than maximum age'); return; }
  if (budgetMin !== null && budgetMax !== null && budgetMin > budgetMax) { alert('❌ Budget min cannot exceed budget max'); return; }
  const budgetRange = (budgetMin !== null || budgetMax !== null) ? { min: budgetMin, max: budgetMax } : null;
  const collab = { id: Date.now(), personaIdx: parseInt(personaIdx), personaName: appState.personas[parseInt(personaIdx)].name, exampleTitle: appState.examples[parseInt(exampleIdx)].title, description: desc, userName: appState.user.name || 'Anonymous', userLocation: appState.user.location || 'Unknown', userPic: appState.user.profilePic || null, userLat: appState.user.lat || null, userLng: appState.user.lng || null, timestamp: new Date().toLocaleString(), requirements: { ageRange: {min: minAge, max: maxAge}, maxDistance: maxDist, budgetRange: budgetRange, minExperience: minExp, minProfileRating: minProfileRating, minPictureRating: minPictureRating, preferredGender: prefGender }, ratings: [], comments: [] };
  const editIdx = document.getElementById('editingCollabIdx').value;
  if (editIdx) { appState.collabs[parseInt(editIdx)] = collab; alert('✓ Collab request updated!'); } else { appState.collabs.push(collab); alert('✓ Collab request posted!'); }
  document.getElementById('collabPersona').value = '';
  document.getElementById('collabPublicExample').value = '';
  document.getElementById('collabPostDesc').value = '';
  document.getElementById('collabMinAge').value = '';
  document.getElementById('collabMaxAge').value = '';
  document.getElementById('collabMaxDistance').value = '';
  document.getElementById('collabBudgetMin').value = '';
  document.getElementById('collabBudgetMax').value = '';
  document.getElementById('collabMinExp').value = '';
  document.getElementById('collabMinProfileRating').value = '';
  document.getElementById('collabMinPictureRating').value = '';
  document.getElementById('collabPreferredGender').value = '';
  cancelEditCollab();
  renderCollabFeed();
  saveAppState();
}

function formatBudgetRange(budgetRange) {
  // Support old single-number budgets for backward compatibility
  if (budgetRange === null || budgetRange === undefined) return 'Any';
  if (typeof budgetRange === 'number') return `$${budgetRange.toLocaleString()}`;
  const min = budgetRange.min;
  const max = budgetRange.max;
  const hasMin = Number.isFinite(min);
  const hasMax = Number.isFinite(max);
  if (hasMin && hasMax) return `$${min.toLocaleString()} - $${max.toLocaleString()}`;
  if (hasMin) return `$${min.toLocaleString()}+`;
  if (hasMax) return `Up to $${max.toLocaleString()}`;
  return 'Any';
}

function renderCollabFeed() {
  try {
    const feed = document.getElementById('collabFeed');
    if (!feed) return;
    appState.filteredCollabs = [...appState.collabs];
    const filterPersona = document.getElementById('filterPersona');
    const filterPersonaVal = filterPersona ? filterPersona.value : '';
    const filterLocation = document.getElementById('filterLocation');
    const filterLocationVal = filterLocation ? filterLocation.value : '';
    if (filterPersonaVal) appState.filteredCollabs = appState.filteredCollabs.filter(c => c.personaName === filterPersonaVal);
    if (filterLocationVal) appState.filteredCollabs = appState.filteredCollabs.filter(c => c.userLocation.toLowerCase().includes(filterLocationVal.toLowerCase()));
    const feedCount = document.getElementById('feedCount');
    if (feedCount) feedCount.textContent = appState.filteredCollabs.length;
    if (appState.filteredCollabs.length === 0) { feed.innerHTML = 'No collaboration requests matching your filters'; return; }
    feed.innerHTML = '';
    appState.filteredCollabs.forEach((collab, idx) => {
      try {
        const originalIdx = appState.collabs.findIndex(c => c.id === collab.id);
        const card = document.createElement('div');
        card.className = 'post-card';
        card.innerHTML = `<div class="post-header"><div class="post-avatar" ${collab.userPic ? `style="background-image: url('${collab.userPic}'); background-size: cover; background-position: center;"` : ''}>${!collab.userPic ? '🎤' : ''}</div><div class="post-info" style="flex: 1;"><div class="post-user">${collab.personaName}</div><div class="post-meta">by ${collab.userName}</div><div class="post-meta">📍 ${collab.userLocation}</div><div class="post-meta">${collab.timestamp}</div></div></div><div style="margin-bottom: 10px;"><div style="font-size: 11px; margin-bottom: 6px; font-weight: 600;">Work: ${collab.exampleTitle}</div><div style="font-size: 12px;">${collab.description}</div></div><div class="post-actions"><button class="btn btn-secondary btn-small" onclick="editCollab(${originalIdx})">✏️ Edit</button><button class="btn btn-danger btn-small" onclick="removeCollab(${originalIdx})">🗑️ Delete</button></div>`;
        feed.appendChild(card);
      } catch (e) {
        console.error('Error rendering collab card:', e);
      }
    });
  } catch (e) {
    console.error('renderCollabFeed error:', e);
  }
}

function editCollab(idx) {
  const collab = appState.collabs[idx];
  document.getElementById('collabPersona').value = appState.personas.findIndex(p => p.name === collab.personaName);
  updateCollabExampleOptions();
  document.getElementById('collabPublicExample').value = appState.examples.findIndex(ex => ex.title === collab.exampleTitle);
  document.getElementById('collabPostDesc').value = collab.description;
  const req = collab.requirements || {};
  const br = req.budgetRange || null;
  const legacyBudget = typeof req.budget === 'number' ? req.budget : null;
  document.getElementById('collabBudgetMin').value = br && br.min !== null && br.min !== undefined ? br.min : (legacyBudget !== null ? legacyBudget : '');
  document.getElementById('collabBudgetMax').value = br && br.max !== null && br.max !== undefined ? br.max : '';
  document.getElementById('editingCollabIdx').value = idx;
  document.getElementById('collabSubmitBtn').textContent = '✏️ Update';
  document.getElementById('collabCancelBtn').style.display = 'block';
  switchTab('collaborate');
}

function cancelEditCollab() {
  document.getElementById('editingCollabIdx').value = '';
  document.getElementById('collabSubmitBtn').textContent = '📤 Post';
  document.getElementById('collabCancelBtn').style.display = 'none';
  document.getElementById('collabPersona').value = '';
  document.getElementById('collabPublicExample').value = '';
  document.getElementById('collabPostDesc').value = '';
  document.getElementById('collabBudgetMin').value = '';
  document.getElementById('collabBudgetMax').value = '';
}

function removeCollab(idx) { if (confirm('Delete this collaboration request?')) { appState.collabs.splice(idx, 1); renderCollabFeed(); saveAppState(); } }

function applyFilters() { renderCollabFeed(); }

function resetFilters() {
  document.getElementById('filterPersona').value = '';
  document.getElementById('filterLocation').value = '';
  renderCollabFeed();
}

function addIncome() {
  const amt = parseFloat(document.getElementById('incomeAmt').value);
  const taxRate = parseFloat(document.getElementById('incomeTaxRate').value) || 5;
  if (!amt || amt <= 0) { alert('❌ Please enter a valid amount'); return; }
  const taxAmount = amt * (taxRate / 100);
  const afterTax = amt - taxAmount;
  appState.wallet.balance += afterTax;
  appState.wallet.earned += amt;
  if (!appState.wallet.taxCollected) appState.wallet.taxCollected = 0;
  appState.wallet.taxCollected += taxAmount;
  document.getElementById('incomeAmt').value = '';
  updateWalletDisplay();
  saveAppState();
  alert(`✓ Added $${amt.toFixed(2)} (tax: $${taxAmount.toFixed(2)}, net: $${afterTax.toFixed(2)})`);
}

function safeSetText(id, text) {
  const el = document.getElementById(id);
  if (el) { el.textContent = text; }
}

function safeSetValue(id, value) {
  const el = document.getElementById(id);
  if (el) { el.value = value; }
}

function updateWalletDisplay() {
  safeSetText('walletBalance', appState.wallet.balance.toFixed(2));
  safeSetText('walletEarned', appState.wallet.earned.toFixed(2));
  safeSetText('balanceAmount', appState.wallet.balance.toFixed(2));
  
  // Update tax summary
  const taxCollected = appState.wallet.taxCollected || 0;
  const netIncome = appState.wallet.balance || 0;
  safeSetText('totalTaxCollected', '$' + taxCollected.toFixed(2));
  safeSetText('netIncome', '$' + netIncome.toFixed(2));
}

function updateAllDisplays() {
  updateWalletDisplay();
  renderPersonasDisplay();
  renderExamplesDisplay();
  updateCollabPersonaOptions();
  renderCollabFeed();
  updateProfileDisplay();
  safeSetValue('username', appState.user.name);
  safeSetValue('email', appState.user.email);
  safeSetValue('phone', appState.user.phone);
  safeSetValue('birthday', appState.user.birthday);
  safeSetValue('gender', appState.user.gender);
  safeSetValue('location', appState.user.location);
  safeSetValue('bio', appState.user.bio);
  updateAuthDisplay();
}

function toggleTheme() {
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', newTheme);
  safeStorageSet('theme', newTheme);
  updateThemeButton(newTheme);
}

function updateThemeButton(theme) {
  const btn = document.querySelector('.theme-toggle');
  btn.textContent = theme === 'dark' ? '☀️' : '🌙';
}

function copyEmail() {
  const email = appState.user.email;
  if (!email) { alert('❌ No email to copy'); return; }
  navigator.clipboard.writeText(email).then(() => { alert(`✓ Email copied: ${email}`); }).catch(() => { alert('❌ Could not copy email'); });
}

function initMap() {
  const mapContainer = document.getElementById('collabMap');
  if (!mapContainer) return;
  try {
    if (typeof google === 'undefined' || !google.maps || !google.maps.Map) {
      mapContainer.innerHTML = '<div style="padding:10px; color: var(--text-light); text-align:center;">Map unavailable</div>';
      return;
    }
  } catch (e) {
    mapContainer.innerHTML = '<div style="padding:10px; color: var(--text-light); text-align:center;">Map error</div>';
    return;
  }
  const userLat = appState.user.lat || 40.7128;
  const userLng = appState.user.lng || -74.0060;
  const mapOptions = { zoom: 12, center: { lat: userLat, lng: userLng }, mapTypeControl: false };
  
  try {
    appState.map = new google.maps.Map(mapContainer, mapOptions);
  } catch (e) {
    console.error('Map init error:', e);
    mapContainer.innerHTML = '<div style="padding:10px; color: var(--text-light); text-align:center;">Map failed to load</div>';
  }
  
  // Add user's location marker
  new google.maps.Marker({
    position: { lat: userLat, lng: userLng },
    map: appState.map,
    title: appState.user.name || 'Your Location',
    icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
  });
  
  renderMapUsers();
}

function calculateDistance(lat1, lng1, lat2, lng2) {
  const R = 3959; // Earth's radius in miles
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function renderMapUsers() {
  const mapUsersList = document.getElementById('mapUsersList');
  if (!mapUsersList) return;
  mapUsersList.innerHTML = '';
  
  appState.userMarkers.forEach(marker => marker.setMap(null));
  appState.userMarkers = [];
  
  if (!appState.map) return;
  
  const userLat = appState.user.lat || 40.7128;
  const userLng = appState.user.lng || -74.0060;
  
  appState.filteredCollabs.forEach((collab, idx) => {
    const originalIdx = appState.collabs.findIndex(c => c.id === collab.id);
    if (!collab.userLat || !collab.userLng) return;
    
    const distance = calculateDistance(userLat, userLng, collab.userLat, collab.userLng);
    const avgRating = collab.ratings && collab.ratings.length > 0 ? (collab.ratings.reduce((a, b) => a + b, 0) / collab.ratings.length).toFixed(1) : 'N/A';
    const req = collab.requirements || {};
    
    // Add map marker
    const marker = new google.maps.Marker({
      position: { lat: collab.userLat, lng: collab.userLng },
      map: appState.map,
      title: collab.userName
    });
    
    // Build info window content
    const infoContent = `<div style="font-size: 11px; max-width: 250px;"><div style="font-weight: 700; margin-bottom: 4px;">${collab.userName}</div><div style="color: #FFD700; margin-bottom: 4px;">⭐ ${avgRating}</div><div style="font-size: 10px; margin-bottom: 6px;">📍 ${distance.toFixed(1)} miles away</div><div style="margin-bottom: 6px; padding-top: 6px; border-top: 1px solid #ddd;"><div style="font-weight: 600; margin-bottom: 2px;">🎯 Seeking:</div>${req.ageRange ? `<div>👥 Age: ${req.ageRange.min}-${req.ageRange.max}</div>` : ''}<div>💵 Budget: ${formatBudgetRange(req.budgetRange ?? req.budget)}</div><div>📊 Min Exp: ${req.minExperience || 0} yrs</div></div></div>`;
    
    const infoWindow = new google.maps.InfoWindow({ content: infoContent });
    marker.addListener('click', () => infoWindow.open(appState.map, marker));
    appState.userMarkers.push(marker);
    
    // Add to list
    const card = document.createElement('div');
    card.className = 'user-card-on-map';
    card.innerHTML = `<div class="user-card-header"><div class="user-card-avatar" ${collab.userPic ? `style="background-image: url('${collab.userPic}'); background-size: cover;"` : ''}>${!collab.userPic ? '🎤' : ''}</div><div class="user-card-title"><div class="user-name">${collab.userName}</div><div class="user-rating">⭐ ${avgRating} • 📍 ${distance.toFixed(1)}mi</div></div></div><div class="user-card-content"><div><strong>👤 Persona:</strong> ${collab.personaName}</div><div><strong>🎵 Work:</strong> ${collab.exampleTitle}</div>${req.minExperience ? `<div><strong>📊 Min Exp:</strong> ${req.minExperience} years</div>` : ''}<div><strong>💰 Budget:</strong> ${formatBudgetRange(req.budgetRange ?? req.budget)}</div><div><strong>📏 Distance:</strong> ${distance.toFixed(1)} miles max ${req.maxDistance ? `(Requested: ${req.maxDistance}mi)` : ''}</div>${req.ageRange ? `<div><strong>👥 Age Range:</strong> ${req.ageRange.min}-${req.ageRange.max} years</div>` : ''}<div><strong>⚧️ Gender:</strong> ${req.preferredGender || 'Any'}</div></div>`;
    mapUsersList.appendChild(card);
  });
}


// Auth Functions
function setAuthStatus(message, isError = false) {
  const status = document.getElementById('authStatus');
  const overlayStatus = document.getElementById('authOverlayStatus');
  if (status) {
    status.textContent = message;
    status.style.color = isError ? '#F44336' : 'var(--text-light)';
  }
  if (overlayStatus) {
    overlayStatus.textContent = message;
    overlayStatus.style.color = isError ? '#F44336' : 'var(--text-light)';
  }
}

async function registerUser(fromOverlay = false) {
  const email = (document.getElementById(fromOverlay ? 'authOverlayEmail' : 'authEmail').value || '').trim();
  const password = (document.getElementById(fromOverlay ? 'authOverlayPassword' : 'authPassword').value || '').trim();
  const username = (document.getElementById(fromOverlay ? 'authOverlayUsername' : 'authUsername').value || '').trim();
  const phone = fromOverlay ? (document.getElementById('authOverlayPhone').value || '').trim() : '';

  if (!email || !password) { setAuthStatus('Email and password required.', true); return; }
  if (password.length < 8) { setAuthStatus('Password must be at least 8 characters.', true); return; }

  try {
    setAuthStatus('Registering...');
    const res = await fetch(`${apiBase}/api/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password, username, phone })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      setAuthStatus(data.error || 'Registration failed.', true);
      return;
    }

    appState.auth = { loggedIn: true, user: data.user };
    saveAppState();
    updateAuthDisplay();
    setAuthStatus(`Registered & logged in as ${data.user.email}`);
  } catch (e) {
    console.error('registerUser error:', e);
    setAuthStatus('Registration error. Check server.', true);
  }
}

async function loginUser(fromOverlay = false) {
  const email = (document.getElementById(fromOverlay ? 'authOverlayEmail' : 'authEmail').value || '').trim();
  const password = (document.getElementById(fromOverlay ? 'authOverlayPassword' : 'authPassword').value || '').trim();

  if (!email || !password) { setAuthStatus('Email and password required.', true); return; }

  try {
    setAuthStatus('Logging in...');
    const res = await fetch(`${apiBase}/api/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      setAuthStatus(data.error || 'Login failed.', true);
      return;
    }

    appState.auth = { loggedIn: true, user: data.user };
    saveAppState();
    updateAuthDisplay();
    setAuthStatus(`Logged in as ${data.user.email}`);
  } catch (e) {
    console.error('loginUser error:', e);
    setAuthStatus('Login error. Check server.', true);
  }
}

function logoutUser() {
  appState.auth = { loggedIn: false, user: null, guest: false };
  saveAppState();
  updateAuthDisplay();
  const passwordInput = document.getElementById('authPassword');
  if (passwordInput) { passwordInput.value = ''; }
  setAuthStatus('Logged out.');
}

function continueAsGuest() {
  appState.auth = { loggedIn: false, user: null, guest: true };
  saveAppState();
  updateAuthDisplay();
  setAuthStatus('Guest mode enabled.');
}

function showPhoneLogin() {
  document.getElementById('authMainView').style.display = 'none';
  document.getElementById('authPhoneView').style.display = 'block';
  document.getElementById('authForgotView').style.display = 'none';
  document.getElementById('authResetView').style.display = 'none';
  setAuthStatus('Enter your phone number and password.');
}

function showForgotPassword() {
  document.getElementById('authMainView').style.display = 'none';
  document.getElementById('authPhoneView').style.display = 'none';
  document.getElementById('authForgotView').style.display = 'block';
  document.getElementById('authResetView').style.display = 'none';
  setAuthStatus('Enter your email to receive a reset code.');
}

function backToMainAuth() {
  document.getElementById('authMainView').style.display = 'block';
  document.getElementById('authPhoneView').style.display = 'none';
  document.getElementById('authForgotView').style.display = 'none';
  document.getElementById('authResetView').style.display = 'none';
  setAuthStatus('Not logged in');
}

async function loginWithPhone() {
  const phone = (document.getElementById('authPhoneNumber').value || '').trim();
  const password = (document.getElementById('authPhonePassword').value || '').trim();

  if (!phone || !password) { setAuthStatus('Phone and password required.', true); return; }

  try {
    setAuthStatus('Logging in...');
    const res = await fetch(`${apiBase}/api/login-phone`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone, password })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      setAuthStatus(data.error || 'Login failed.', true);
      return;
    }

    appState.auth = { loggedIn: true, user: data.user };
    saveAppState();
    updateAuthDisplay();
    setAuthStatus(`Logged in via phone as ${data.user.email}`);
    backToMainAuth();
  } catch (e) {
    console.error('loginWithPhone error:', e);
    setAuthStatus('Login error. Check server.', true);
  }
}

async function requestPasswordReset() {
  const email = (document.getElementById('authForgotEmail').value || '').trim();

  if (!email) { setAuthStatus('Email required.', true); return; }

  try {
    setAuthStatus('Sending reset code...');
    const res = await fetch(`${apiBase}/api/forgot-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      setAuthStatus(data.error || 'Reset request failed.', true);
      return;
    }

    // Store email for reset completion
    window.resetEmail = email;
    
    // Show reset code (for development - remove in production)
    if (data.resetCode) {
      setAuthStatus(`Reset code: ${data.resetCode} (check console for production)`);
    } else {
      setAuthStatus('Reset code sent to your email.');
    }
    
    // Switch to reset view
    document.getElementById('authForgotView').style.display = 'none';
    document.getElementById('authResetView').style.display = 'block';
  } catch (e) {
    console.error('requestPasswordReset error:', e);
    setAuthStatus('Reset request error. Check server.', true);
  }
}

async function completePasswordReset() {
  const code = (document.getElementById('authResetCode').value || '').trim();
  const newPassword = (document.getElementById('authResetPassword').value || '').trim();
  const email = window.resetEmail;

  if (!email || !code || !newPassword) { 
    setAuthStatus('All fields required.', true); 
    return; 
  }
  if (newPassword.length < 8) { 
    setAuthStatus('Password must be at least 8 characters.', true); 
    return; 
  }

  try {
    setAuthStatus('Resetting password...');
    const res = await fetch(`${apiBase}/api/reset-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, code, newPassword })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      setAuthStatus(data.error || 'Reset failed.', true);
      return;
    }

    setAuthStatus('Password reset successful! You can now login.');
    delete window.resetEmail;
    
    // Clear fields and go back to main view after 2 seconds
    setTimeout(() => {
      document.getElementById('authResetCode').value = '';
      document.getElementById('authResetPassword').value = '';
      document.getElementById('authForgotEmail').value = '';
      backToMainAuth();
    }, 2000);
  } catch (e) {
    console.error('completePasswordReset error:', e);
    setAuthStatus('Reset error. Check server.', true);
  }
}

function socialLogin(provider) {
  // Open OAuth flow in popup window
  const width = 600;
  const height = 700;
  const left = (window.screen.width - width) / 2;
  const top = (window.screen.height - height) / 2;
  
  const popup = window.open(
    `${apiBase}/api/auth/${provider}`,
    `${provider}Login`,
    `width=${width},height=${height},left=${left},top=${top}`
  );
  
  if (!popup) {
    setAuthStatus('Please allow popups for social login.', true);
    return;
  }
  
  setAuthStatus(`Connecting to ${provider}...`);
}

// Listen for social login callback
window.addEventListener('load', () => {
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('social_login') === 'success') {
    try {
      const userData = JSON.parse(decodeURIComponent(urlParams.get('user')));
      appState.auth = { loggedIn: true, user: userData };
      saveAppState();
      updateAuthDisplay();
      setAuthStatus(`Logged in as ${userData.email}`);
      
      // Clean up URL
      window.history.replaceState({}, document.title, window.location.pathname);
    } catch (e) {
      console.error('Social login callback error:', e);
      setAuthStatus('Social login error.', true);
    }
  }
});

function updateAuthDisplay() {
  const overlay = document.getElementById('authOverlay');
  const overlayEmail = document.getElementById('authOverlayEmail');
  const overlayPassword = document.getElementById('authOverlayPassword');
  const overlayUsername = document.getElementById('authOverlayUsername');
  const emailInput = document.getElementById('authEmail');
  const passwordInput = document.getElementById('authPassword');
  const usernameInput = document.getElementById('authUsername');
  const registerBtn = document.getElementById('registerBtn');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  if (!emailInput || !passwordInput || !usernameInput || !registerBtn || !loginBtn || !logoutBtn) return;

  const loggedIn = !!(appState.auth && appState.auth.loggedIn);
  const isGuest = !!(appState.auth && appState.auth.guest);
  const user = appState.auth ? appState.auth.user : null;

  if (user && user.email) { emailInput.value = user.email; }
  if (user && user.username) { usernameInput.value = user.username; }
  if (overlayEmail && user && user.email) { overlayEmail.value = user.email; }
  if (overlayUsername && user && user.username) { overlayUsername.value = user.username; }

  emailInput.disabled = loggedIn;
  passwordInput.disabled = loggedIn;
  usernameInput.disabled = loggedIn;

  if (loggedIn) { passwordInput.value = ''; }
  if (overlayPassword && loggedIn) { overlayPassword.value = ''; }

  registerBtn.style.display = loggedIn ? 'none' : 'inline-flex';
  loginBtn.style.display = loggedIn ? 'none' : 'inline-flex';
  logoutBtn.style.display = loggedIn ? 'inline-flex' : 'none';

  if (loggedIn && user && user.email) {
    setAuthStatus(`Logged in as ${user.email}`);
  } else if (!loggedIn && isGuest) {
    setAuthStatus('Guest mode enabled.');
  } else if (!loggedIn) {
    setAuthStatus('Not logged in');
  }

  if (overlay) {
    overlay.classList.toggle('active', !loggedIn && !isGuest);
  }
}


// Settings Functions
function applyTheme(themeName, primaryColor, primaryDark) {
  document.documentElement.style.setProperty('--primary', primaryColor);
  document.documentElement.style.setProperty('--primary-dark', primaryDark);
  appState.settings.theme = themeName;
  saveAppState();
  document.querySelectorAll('.theme-color-btn').forEach(btn => btn.classList.remove('active'));
  event.target.closest('.theme-color-btn').classList.add('active');
}

function toggleDarkMode() {
  const html = document.documentElement;
  const isDark = appState.settings.darkMode;
  appState.settings.darkMode = !isDark;
  html.setAttribute('data-theme', !isDark ? 'dark' : 'light');
  updateThemeButton(!isDark ? 'dark' : 'light');
  const toggle = document.getElementById('darkModeToggle');
  toggle.classList.toggle('on');
  saveAppState();
}

function toggleNotification(type) {
  if (type === 'email') {
    if (!appState.settings.emailVerified) { alert('Verify your email before enabling email notifications.'); return; }
    appState.settings.emailNotifications = !appState.settings.emailNotifications;
    document.getElementById('emailNotifToggle').classList.toggle('on', appState.settings.emailNotifications);
  } else if (type === 'push') {
    appState.settings.pushNotifications = !appState.settings.pushNotifications;
    document.getElementById('pushNotifToggle').classList.toggle('on', appState.settings.pushNotifications);
  } else if (type === 'phone') {
    if (!appState.settings.phoneVerified) { alert('Verify your phone number before enabling SMS notifications.'); return; }
    appState.settings.phoneNotifications = !appState.settings.phoneNotifications;
    document.getElementById('phoneNotifToggle').classList.toggle('on', appState.settings.phoneNotifications);
  }
  saveAppState();
}

function changeLanguage(lang) {
  appState.settings.language = lang;
  saveAppState();
  alert(`Language changed to ${lang}`);
}

function sendVerificationEmail() {
  const email = appState.user.email;
  if (!email) { alert('Please set an email in your profile first'); return; }
  alert(`✅ Verification email sent to ${email}. Check your inbox!`);
  appState.settings.emailVerified = true;
  updateVerificationStatus('email', true);
  refreshNotificationToggles();
  saveAppState();
}

function sendVerificationSMS() {
  const phone = appState.user.phone;
  if (!phone) { alert('Please set a phone number in your profile first'); return; }
  alert(`✅ Verification SMS sent to ${phone}. Check your messages!`);
  appState.settings.phoneVerified = true;
  updateVerificationStatus('phone', true);
  refreshNotificationToggles();
  saveAppState();
}

function updateVerificationStatus(type, verified) {
  const statusEl = document.getElementById(type === 'email' ? 'emailVerifStatus' : 'phoneVerifStatus');
  if (verified) {
    statusEl.classList.remove('unverified');
    statusEl.classList.add('verified');
    statusEl.innerHTML = '<span>✅</span><span>' + (type === 'email' ? 'Email' : 'Phone') + ' verified</span>';
  } else {
    statusEl.classList.remove('verified');
    statusEl.classList.add('unverified');
    statusEl.innerHTML = '<span>❌</span><span>' + (type === 'email' ? 'Email' : 'Phone') + ' not verified</span>';
  }
}

function refreshNotificationToggles() {
  // Force-off and disable toggles that require verification
  if (!appState.settings.emailVerified) {
    appState.settings.emailNotifications = false;
    document.getElementById('emailNotifToggle').classList.remove('on');
    document.getElementById('emailNotifToggle').classList.add('disabled');
    document.getElementById('emailNotifToggle').setAttribute('title', 'Verify email to enable');
  } else {
    document.getElementById('emailNotifToggle').classList.remove('disabled');
    document.getElementById('emailNotifToggle').removeAttribute('title');
  }

  if (!appState.settings.phoneVerified) {
    appState.settings.phoneNotifications = false;
    document.getElementById('phoneNotifToggle').classList.remove('on');
    document.getElementById('phoneNotifToggle').classList.add('disabled');
    document.getElementById('phoneNotifToggle').setAttribute('title', 'Verify phone to enable');
  } else {
    document.getElementById('phoneNotifToggle').classList.remove('disabled');
    document.getElementById('phoneNotifToggle').removeAttribute('title');
  }

  // Push notifications do not require verification
  document.getElementById('pushNotifToggle').classList.toggle('on', appState.settings.pushNotifications);
}

// Surface runtime errors on-screen to diagnose unresponsive UI
let _errorBannerShown = false;
window.addEventListener('error', (event) => {
  if (_errorBannerShown) return;
  _errorBannerShown = true;
  const banner = document.createElement('div');
  banner.style.position = 'fixed';
  banner.style.left = '12px';
  banner.style.right = '12px';
  banner.style.bottom = '12px';
  banner.style.zIndex = '9999';
  banner.style.background = '#B00020';
  banner.style.color = 'white';
  banner.style.padding = '10px 12px';
  banner.style.borderRadius = '8px';
  banner.style.fontSize = '12px';
  banner.style.boxShadow = '0 6px 18px rgba(0,0,0,0.3)';
  banner.textContent = `Runtime error: ${event.message || 'Unknown error'} (see console for details)`;
  document.body.appendChild(banner);
});

function exportData() {
  const dataStr = JSON.stringify(appState, (key, value) => value instanceof Set ? Array.from(value) : value);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'MusicConnectZ_backup_' + new Date().toISOString() + '.json';
  a.click();
  alert('✅ Data exported successfully!');
}

function resetSettings() {
  if (!confirm('Are you sure? This will reset all settings to default.')) return;
  appState.settings = {
    theme: 'blue',
    darkMode: false,
    language: 'English',
    emailNotifications: true,
    pushNotifications: true,
    phoneNotifications: false,
    emailVerified: false,
    phoneVerified: false
  };
  saveAppState();
  document.documentElement.setAttribute('data-theme', 'light');
  document.documentElement.style.setProperty('--primary', '#2196F3');
  document.documentElement.style.setProperty('--primary-dark', '#1565C0');
  alert('✅ Settings reset to default!');
  location.reload();
}

function initializeSettings() {
  document.getElementById('languageSelect').value = appState.settings.language;
  if (appState.settings.darkMode) {
    document.getElementById('darkModeToggle').classList.add('on');
  }
  // Enforce verification gating before applying toggle states
  refreshNotificationToggles();
  document.getElementById('emailNotifToggle').classList.toggle('on', appState.settings.emailNotifications && appState.settings.emailVerified);
  document.getElementById('pushNotifToggle').classList.toggle('on', appState.settings.pushNotifications);
  document.getElementById('phoneNotifToggle').classList.toggle('on', appState.settings.phoneNotifications && appState.settings.phoneVerified);
  updateVerificationStatus('email', appState.settings.emailVerified);
  updateVerificationStatus('phone', appState.settings.phoneVerified);
  document.querySelectorAll('.theme-color-btn').forEach((btn, idx) => {
    if ((idx === 0 && appState.settings.theme === 'blue') || (idx === 1 && appState.settings.theme === 'orange') || (idx === 2 && appState.settings.theme === 'purple') || (idx === 3 && appState.settings.theme === 'red') || (idx === 4 && appState.settings.theme === 'cyan') || (idx === 5 && appState.settings.theme === 'pink') || (idx === 6 && appState.settings.theme === 'green') || (idx === 7 && appState.settings.theme === 'amber') || (idx === 8 && appState.settings.theme === 'deep-purple')) {
      btn.classList.add('active');
    }
  });
}

window.addEventListener('beforeunload', () => { saveAppState(); });

console.log('=== PAGE LOADED - SCHEDULING INITIALIZATION ===');

// Schedule initialization to happen asynchronously
setTimeout(() => {
  try {
    console.log('Starting deferred initialization...');
    loadAppState();
    console.log('loadAppState complete');
    
    // Only update auth display, skip heavy renders
    updateAuthDisplay();
    console.log('updateAuthDisplay complete');
    
    // Show the setup tab by default
    const setupTab = document.getElementById('setup');
    if (setupTab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      setupTab.classList.add('active');
      const allButtons = document.querySelectorAll('.tab-btn');
      if (allButtons.length > 0) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        allButtons[0].classList.add('active');
      }
    }
    console.log('=== INITIALIZATION COMPLETE ===');
  } catch (e) {
    console.error('Initialization error:', e);
  }
}, 100);

document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    if (e.key === 'ArrowLeft') { e.preventDefault(); prevTab(); }
    else if (e.key === 'ArrowRight') { e.preventDefault(); nextTab(); }
  }
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
  }
});
</script>
</body>
</html>






